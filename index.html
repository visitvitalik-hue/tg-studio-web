<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>CADRART ‚Äî MiniApp</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);

      --bg: #050505;
      --panel: #121212;
      --panel2: #0d0d0d;
      --stroke: rgba(255,255,255,.08);
      --stroke2: rgba(255,255,255,.12);
      --text2: rgba(255,255,255,.70);

      --blue: #3B82F6;
      --amber: #F59E0B;
      --green: #10B981;

      --tap: 44px;
      --r: 18px;
    }

    html, body { height: 100%; }
    body{
      font-family: 'Outfit', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 15% 10%, rgba(59,130,246,.18), transparent 40%),
                  radial-gradient(900px 600px at 85% 0%, rgba(245,158,11,.12), transparent 45%),
                  radial-gradient(1200px 800px at 50% 120%, rgba(16,185,129,.10), transparent 40%),
                  var(--bg);
      color: #fff;
      -webkit-tap-highlight-color: transparent;
      min-height: 100dvh;
      padding-top: calc(var(--safe-top) + 8px);
      padding-bottom: calc(var(--safe-bot) + 10px);
      padding-left: calc(var(--safe-left) + 10px);
      padding-right: calc(var(--safe-right) + 10px);
      overflow-x: hidden;
    }

    /* iOS zoom fix */
    input, textarea, select { font-size: 16px; }

    .app{
      max-width: 560px;
      margin: 0 auto;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 60;
      padding-top: 4px;
      backdrop-filter: blur(10px);
      background: rgba(5,5,5,.7);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .tabs{
      display: flex;
      gap: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding: 8px 2px 10px 2px;
    }
    .tabs::-webkit-scrollbar{ display:none; }

    .tab-btn{
      flex: 0 0 auto;
      min-height: var(--tap);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(18,18,18,.75);
      color: rgba(255,255,255,.7);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .5px;
      transition: .18s ease;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .tab-btn.active{
      color:#fff;
      border-color: rgba(59,130,246,.45);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
      background: rgba(18,18,18,.95);
    }

    .card{
      background: rgba(18,18,18,.82);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--r);
      padding: 14px;
    }

    .mode-card{
      background: rgba(18,18,18,.82);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-height: 92px;
      cursor: pointer;
      transition: .16s ease;
      user-select:none;
    }
    .mode-card:active{ transform: scale(.99); }
    .mode-card.active{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
      background: rgba(18,18,18,.95);
    }

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.62);
      line-height: 1.35;
    }

    .label{
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.52);
    }

    .input{
      width:100%;
      background: rgba(10,10,10,.75);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      color:#fff;
      outline:none;
      transition:.15s ease;
    }
    .input:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    .media-box{
      width: 100%;
      height: 220px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
    }

    video{ width:100%; height:100%; object-fit: contain; background:#000; }

    .content{
      padding-bottom: 108px; /* –ø–æ–¥ –Ω–∏–∂–Ω–∏–π —Ä—É–ª—å */
    }

    .action-bar{
      position: sticky;
      bottom: 0;
      z-index: 80;
      margin-top: 10px;
      padding: 10px;
      border-radius: 16px;
      backdrop-filter: blur(12px);
      background: rgba(12,12,12,.70);
      border: 1px solid rgba(255,255,255,.10);
    }

    .btn{
      min-height: var(--tap);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      letter-spacing: .02em;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(20,20,20,.85);
      color: #fff;
      transition: .14s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(59,130,246,.70));
      border-color: rgba(59,130,246,.50);
      box-shadow: 0 10px 30px rgba(59,130,246,.18);
    }
    .btn.ghost{
      background: rgba(20,20,20,.55);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.72);
    }

    .hidden{ display:none !important; }

    /* Bottom sheet modal */
    .sheet{
      position: fixed;
      inset: 0;
      z-index: 120;
      display:none;
      align-items: flex-end;
      justify-content: center;
      padding: 12px;
      padding-bottom: calc(var(--safe-bot) + 12px);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    .sheet.open{ display:flex; }
    .sheet-card{
      width: min(620px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(12,12,12,.92);
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .sheet-head{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .sheet-title{
      font-weight: 900;
      letter-spacing: .02em;
    }
    .sheet-body{
      padding: 14px;
    }

    /* Cropper preview */
    .preview-wrap{
      width:100%;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background:#000;
      position: relative;
      touch-action: none;
    }

    .preview-canvas{
      width:100%;
      height:100%;
      display:block;
    }

    .mask{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .mask.circle::before{
      content:"";
      width: 78%;
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      box-shadow:
        0 0 0 9999px rgba(0,0,0,.55),
        inset 0 0 0 2px rgba(255,255,255,.18);
    }
    .mask.rect::before{
      content:"";
      width: 86%;
      aspect-ratio: var(--ar, 16/9);
      border-radius: 16px;
      box-shadow:
        0 0 0 9999px rgba(0,0,0,.55),
        inset 0 0 0 2px rgba(255,255,255,.18);
    }
    .mask.grid::before{
      content:"";
      width: 88%;
      aspect-ratio: 1 / 1;
      border-radius: 16px;
      box-shadow:
        0 0 0 9999px rgba(0,0,0,.55),
        inset 0 0 0 2px rgba(255,255,255,.18);
    }
    .gridlines{
      position:absolute;
      width: 88%;
      aspect-ratio: 1/1;
      border-radius: 16px;
      border: 0;
      pointer-events:none;
      display:none;
    }
    .mask.grid .gridlines{ display:block; }
    .gridlines::before, .gridlines::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(to right, transparent 33%, rgba(255,255,255,.16) 33%, rgba(255,255,255,.16) 34%, transparent 34%, transparent 66%, rgba(255,255,255,.16) 66%, rgba(255,255,255,.16) 67%, transparent 67%),
        linear-gradient(to bottom, transparent 33%, rgba(255,255,255,.16) 33%, rgba(255,255,255,.16) 34%, transparent 34%, transparent 66%, rgba(255,255,255,.16) 66%, rgba(255,255,255,.16) 67%, transparent 67%);
      opacity:.8;
      border-radius: 16px;
    }

    /* Thumbs for emoji strip preview */
    .thumbs{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }
    .thumb{
      border-radius: 12px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background:#000;
      aspect-ratio: 1/1;
    }
    .thumb canvas{ width:100%; height:100%; display:block; }

    @media (min-width: 820px){
      .media-box{ height: 260px; }
      .content{ padding-bottom: 112px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Top -->
    <div class="topbar">
      <div class="flex items-center justify-between px-1">
        <div class="flex items-center gap-2">
          <div class="text-sm font-black tracking-wide">CADRART</div>
          <div class="pill" id="statusPill">‚ö° Ready</div>
        </div>
        <button class="btn ghost" style="min-height:40px;padding:8px 12px" id="helpTopBtn">‚ÑπÔ∏è</button>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="video">üé¨ MEDIA</button>
        <button class="tab-btn" data-tab="text">‚úçÔ∏è TEXT</button>
        <button class="tab-btn" data-tab="partner">ü§ù CLUB</button>
        <button class="tab-btn" data-tab="manual">üß† GUIDE</button>
      </div>
    </div>

    <div class="content">
      <!-- VIDEO -->
      <section id="video-section" class="space-y-4">
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <div class="label">–ó–∞–≥—Ä—É–∑–∫–∞</div>
            <div class="hint" id="fileInfo">MP4/MOV/WEBM</div>
          </div>

          <div class="media-box" id="mediaBox">
            <video id="previewPlayer" class="hidden" playsinline></video>
            <div id="uploadPlaceholder" class="text-center px-6">
              <div class="text-4xl mb-2">üì¶</div>
              <div class="text-sm font-black text-white">–ù–∞–∂–º–∏ ‚Äî –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</div>
              <div class="hint mt-1">–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ ‚Äú—Ä—É–ª—å‚Äù –∫–∞–¥—Ä–∞.</div>
            </div>
          </div>

          <input id="videoInput" type="file" accept="video/mp4,video/quicktime,video/webm,image/*" multiple class="hidden"/>

          <div class="mt-3 space-y-2">
            <div class="label">–ü–æ–¥–ø–∏—Å—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
            <textarea id="videoCaption" rows="2" class="input" placeholder="–¢–µ–∫—Å—Ç –ø–æ–¥ –≤–∏–¥–µ–æ / –ø–æ—Å—Ç‚Ä¶"></textarea>
            <div class="hint">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è: –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–µ–¥–ª–æ–∂–∏–º –µ—â—ë –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (–ø–æ—Å—Ç/–∫–æ–ª–ª–∞–∂/—ç–º–æ–¥–∑–∏).</div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between mb-3">
            <div class="label">–†–µ–∂–∏–º</div>
            <button class="btn ghost" style="min-height:40px;padding:8px 12px" id="openPreviewBtn">üëÄ Preview</button>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="mode-card active" data-mode="circle">
              <div class="text-2xl">üîµ</div>
              <div class="font-black text-sm">Fake Live</div>
              <div class="hint">–ö—Ä—É–∂–æ–∫ (video note). –¢—É—Ç –≤–∞–∂–µ–Ω –∫–∞–¥—Ä.</div>
            </div>

            <div class="mode-card" data-mode="avatar">
              <div class="text-2xl">üü£</div>
              <div class="font-black text-sm">Live Avatar</div>
              <div class="hint">HQ –≤–∏–¥–µ–æ-–∞–≤–∞—Ç–∞—Ä (–Ω–µ –∫—Ä—É–∂–æ–∫!).</div>
            </div>

            <div class="mode-card" data-mode="9_16">
              <div class="text-2xl">üì±</div>
              <div class="font-black text-sm">9:16</div>
              <div class="hint">Stories / Reels. –ö–∞–¥—Ä–∏—Ä—É–µ–º.</div>
            </div>

            <div class="mode-card" data-mode="16_9">
              <div class="text-2xl">üñ•Ô∏è</div>
              <div class="font-black text-sm">16:9</div>
              <div class="hint">YouTube / –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å.</div>
            </div>

            <div class="mode-card" data-mode="grid_3x3">
              <div class="text-2xl">üß©</div>
              <div class="font-black text-sm">Grid 3√ó3</div>
              <div class="hint">–°—Ç–∏–∫–µ—Ä-—Å–µ—Ç / –∫–æ–ª–ª–∞–∂.</div>
            </div>

            <div class="mode-card" data-mode="grid_1xN">
              <div class="text-2xl">‚ú®</div>
              <div class="font-black text-sm">Emoji Strip</div>
              <div class="hint">1‚Ä¶20 —Å–µ–∫—Ü–∏–π. –ü–æ–∫–∞–∂–µ–º —Ä–∞–∑–Ω—ã–µ –∫–∞–¥—Ä—ã.</div>
            </div>

            <div class="mode-card" data-mode="fx_boomerang">
              <div class="text-2xl">‚ôæÔ∏è</div>
              <div class="font-black text-sm">Boomerang</div>
              <div class="hint">–ó–∞–ª–∏–ø–∞–ª–æ–≤–æ.</div>
            </div>

            <div class="mode-card" data-mode="fx_audio">
              <div class="text-2xl">üéµ</div>
              <div class="font-black text-sm">MP3</div>
              <div class="hint">–í—ã—Ç–∞—â–∏—Ç—å –∑–≤—É–∫.</div>
            </div>

            <div class="mode-card" data-mode="slideshow">
              <div class="text-2xl">üì∏</div>
              <div class="font-black text-sm">Slideshow</div>
              <div class="hint">–í–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ.</div>
            </div>
          </div>

          <!-- Emoji Strip controls -->
          <div id="stripSettings" class="mt-4 hidden">
            <div class="flex items-center justify-between mb-2">
              <div class="label">–°–µ–∫—Ü–∏–π</div>
              <div class="pill"><span id="stripCountVal">10</span> / 20</div>
            </div>
            <input id="stripCount" type="range" min="1" max="20" value="10" class="w-full"/>
            <div class="flex items-center justify-between mt-2">
              <button class="btn ghost" id="makeThumbsBtn">üß† –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é –∫–∞–¥—Ä–æ–≤</button>
              <div class="hint">–í –ø—Ä–µ–≤—å—é ‚Äî —Ä–∞–∑–Ω—ã–µ –∫–∞–¥—Ä—ã –ø–æ —Ç–∞–π–º–ª–∞–π–Ω—É.</div>
            </div>
            <div id="thumbsWrap" class="mt-3 hidden">
              <div class="label mb-2">Preview (–∫–∞–¥—Ä—ã)</div>
              <div class="thumbs" id="thumbsGrid"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="label mb-2">–°–µ—Ç—ã ‚Äú–Ω–∞ –≤—ã–±–æ—Ä‚Äù (—É–¥–µ—Ä–∂–∞–Ω–∏–µ)</div>
          <div class="hint mb-3">–°–¥–µ–ª–∞–ª –æ–¥–Ω–æ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏–º —Å–ª–µ–¥—É—é—â–µ–µ. –í—ã–±–∏—Ä–∞–π –ø–∞–∫–µ—Ç, –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤ –±–æ—Ç –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º.</div>
          <div class="grid grid-cols-1 gap-2">
            <button class="btn ghost" id="combo1">üé¨ –í–∏–¥–µ–æ + ‚úçÔ∏è –ü–æ—Å—Ç (3 —Å—Ç–∏–ª—è)</button>
            <button class="btn ghost" id="combo2">‚ú® –≠–º–æ–¥–∑–∏ 1..20 + üß© 3√ó3 + ‚úçÔ∏è –ü–æ—Å—Ç</button>
            <button class="btn ghost" id="combo3">üì± 9:16 + üñ•Ô∏è 16:9 (–¥–≤–∞ –∫–∞–¥—Ä–∞) + ‚úçÔ∏è –ü–æ—Å—Ç</button>
          </div>
        </div>
      </section>

      <!-- TEXT -->
      <section id="text-section" class="space-y-4 hidden">
        <div class="card">
          <div class="label mb-2">–í–∏–∑—É–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø–æ—Å—Ç–æ–≤</div>
          <div class="hint mb-3">–ù–∞–∂–º–∏ —Å—Ç–∏–ª—å ‚Üí —É–≤–∏–¥–∏—à—å –ø—Ä–∏–º–µ—Ä –ø—Ä—è–º–æ –∑–¥–µ—Å—å, –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ ‚Äú–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å‚Äù.</div>

          <div class="grid grid-cols-1 gap-2" id="styleList">
            <button class="btn ghost text-left" data-style="insider">üïµÔ∏è Insider ‚Äî –∏–Ω—Å–∞–π–¥—ã + –∂–∏—Ä–Ω—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã</button>
            <button class="btn ghost text-left" data-style="pov">üëÅÔ∏è POV ‚Äî –∫–æ—Ä–æ—Ç–∫–æ, —Å–ª–µ–Ω–≥, —ç–º–æ—Ü–∏–∏</button>
            <button class="btn ghost text-left" data-style="story">üìñ Story ‚Äî –∫–µ–π—Å, –ø—É—Ç—å, –≤—ã–≤–æ–¥</button>
            <button class="btn ghost text-left" data-style="flash">‚ö° Flash ‚Äî –¥–µ–¥–ª–∞–π–Ω, –æ—Ñ—Ñ–µ—Ä, CTA</button>
            <button class="btn ghost text-left" data-style="aesthetic">‚ú® Aesthetic ‚Äî ‚Äú–∫–∞–∫ –∏–∑ —Ç–æ–ø-–∫–∞–Ω–∞–ª–æ–≤‚Äù, –∫—Ä–∞—Å–∏–≤–æ –∏ –º—è–≥–∫–æ</button>
            <button class="btn ghost text-left" data-style="noir">üñ§ Noir ‚Äî –¥—Ä–∞–º–∞—Ç–∏—á–Ω–æ, –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω–æ</button>
          </div>
        </div>

        <div class="card">
          <div class="label mb-2">Preview –ø–æ—Å—Ç–∞</div>
          <div id="postPreview" class="p-4 rounded-2xl" style="background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.10)">
            <div class="text-sm font-black">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–∏–º–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–∏–ª—è</div>
            <div class="hint mt-1">–ü–æ—Ç–æ–º —Ç—ã –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ—Å–∏—à—å –ò–ò —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫–æ–π –∂–µ –ø–æ —Ç–≤–æ–µ–π —Ç–µ–º–µ.</div>
          </div>

          <div class="mt-4 space-y-2">
            <div class="label">–¢–µ–º–∞</div>
            <textarea id="promptInput" rows="3" class="input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ‚Äú–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∫—Ä—É–∂–æ–∫ –∂–∏–≤—ã–º –∏ –≤–∏—Ä–∞–ª—å–Ω—ã–º‚Äù"></textarea>
          </div>
        </div>
      </section>

      <!-- PARTNER -->
      <section id="partner-section" class="space-y-4 hidden">
        <div class="card" style="border-color: rgba(245,158,11,.28); background: rgba(18,18,18,.86)">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xl font-black text-amber-400">–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–ª—É–±</div>
              <div class="hint">–ó–æ–≤–∏ –¥—Ä—É–∑–µ–π ‚Üí –±–æ–Ω—É—Å—ã ‚Üí VIP / –±–∞–ª–∞–Ω—Å.</div>
            </div>
            <div class="text-3xl">üëë</div>
          </div>
        </div>

        <div class="card">
          <div class="label mb-2">–¢–≤–æ—è —Å—Å—ã–ª–∫–∞</div>
          <div class="flex items-center gap-2">
            <code id="ref-link" class="input" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">loading‚Ä¶</code>
            <button class="btn" id="copyBtn" style="min-width:56px;">üìã</button>
          </div>
          <button class="btn primary w-full mt-3" id="shareBtn">üöÄ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>
        </div>
      </section>

      <!-- MANUAL -->
      <section id="manual-section" class="space-y-4 hidden">
        <div class="card">
          <div class="text-xl font-black">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
          <div class="hint mt-2">
            –¢—É—Ç –ª–æ–≥–∏–∫–∞ ‚Äú–Ω–µ –∑–∞–±—Ä–∞–ª –∏ —É—à—ë–ª‚Äù, –∞ ‚Äú—Å–¥–µ–ª–∞–ª ‚Üí —É–≤–∏–¥–µ–ª ‚Üí –≤—ã–±—Ä–∞–ª —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥‚Äù.
            –ü–æ—ç—Ç–æ–º—É —É –Ω–∞—Å: –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ‚Üí –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –ø–∞–∫–µ—Ç—ã/–∫–æ–º–±–æ ‚Üí –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ—Å—Ç–æ–≤.
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-black">üîµ Fake Live</div>
              <div class="hint">–ö—Ä—É–∂–æ–∫-–≤–∏–¥–µ–æ–∑–∞–º–µ—Ç–∫–∞. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –∫–∞–¥—Ä (—Ä—É–ª—å: –∑—É–º/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ).</div>
            </div>
            <button class="btn ghost" data-quick="circle">–í–∫–ª—é—á–∏—Ç—å</button>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-black">‚ú® Emoji Strip</div>
              <div class="hint">–ù–∞—Ä–µ–∑–∫–∞ 1..20. –ü—Ä–µ–≤—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ –∫–∞–¥—Ä—ã –ø–æ —Ç–∞–π–º–ª–∞–π–Ω—É.</div>
            </div>
            <button class="btn ghost" data-quick="grid_1xN">–í–∫–ª—é—á–∏—Ç—å</button>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-black">üì± 9:16 –∏ üñ•Ô∏è 16:9</div>
              <div class="hint">–ï—Å–ª–∏ ‚Äú–∫–≤–∞–¥—Ä–∞—Ç–∏–∫ –Ω–∞ –ø–æ–ª–µ‚Äù ‚Äî –∑–Ω–∞—á–∏—Ç –Ω—É–∂–Ω–æ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞—Ç—å. –ú—ã –¥–∞—ë–º –∑—É–º/–ø–∞–Ω –∫–∞–∫ –≤ PS.</div>
            </div>
            <button class="btn ghost" data-quick="9_16">–í–∫–ª—é—á–∏—Ç—å</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Bottom —Ä—É–ª–µ–≤–æ–π –±–∞—Ä -->
    <div class="action-bar">
      <button class="btn primary w-full" id="primaryBtn">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
      <div class="grid grid-cols-2 gap-2 mt-2">
        <button class="btn ghost" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="btn ghost" id="previewBtn">üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
      </div>
    </div>
  </div>

  <!-- SHEET: Preview/Crop -->
  <div class="sheet" id="previewSheet">
    <div class="sheet-card">
      <div class="sheet-head">
        <div>
          <div class="sheet-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä + ‚Äú—Ä—É–ª—å‚Äù –∫–∞–¥—Ä–∞</div>
          <div class="hint" id="sheetHint">Pinch-zoom –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏, drag –æ–¥–Ω–∏–º.</div>
        </div>
        <button class="btn ghost" style="min-height:40px;padding:8px 12px" id="closeSheetBtn">‚úï</button>
      </div>

      <div class="sheet-body space-y-3">
        <div class="preview-wrap" id="previewWrap" style="height: 340px;">
          <canvas id="cropCanvas" class="preview-canvas"></canvas>
          <div class="mask rect" id="maskRect" style="--ar: 16/9;">
            <div class="gridlines"></div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button class="btn ghost" id="resetFrameBtn">‚Ü∫ –°–±—Ä–æ—Å</button>
          <button class="btn primary" id="saveFrameBtn">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>

        <div class="hint">
          –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –µ–≥–æ –≤ –±–æ—Ç–∞ (–≤ JSON).  
          –ï—Å–ª–∏ –±–æ—Ç –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–∫: UI –≥–æ—Ç–æ–≤, —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî –ø–æ–¥–∫–ª—é—á–∏–º —Ä–µ–Ω–¥–µ—Ä.
        </div>
      </div>
    </div>
  </div>

  <!-- SHEET: Help -->
  <div class="sheet" id="helpSheet">
    <div class="sheet-card">
      <div class="sheet-head">
        <div class="sheet-title">–ë—ã—Å—Ç—Ä–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞</div>
        <button class="btn ghost" style="min-height:40px;padding:8px 12px" id="closeHelpBtn">‚úï</button>
      </div>
      <div class="sheet-body space-y-3">
        <div class="card">
          <div class="font-black">–ü–æ—á–µ–º—É 16:9 ‚Äú–∫–≤–∞–¥—Ä–∞—Ç–∏–∫ –Ω–∞ –ø–æ–ª–µ‚Äù?</div>
          <div class="hint mt-1">–ü–æ—Ç–æ–º—É —á—Ç–æ –≤–∏–¥–µ–æ ‚Äú–≤–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è‚Äù. –†–µ—à–µ–Ω–∏–µ: –∑—É–º/–ø–∞–Ω –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ ‚Üí –≤—ã–±—Ä–∞—Ç—å —Ä–∞–∫—É—Ä—Å.</div>
        </div>
        <div class="card">
          <div class="font-black">–ü–æ—á–µ–º—É –∫—Ä—É–∂–æ–∫ –±—ã–≤–∞–µ—Ç ‚Äú—ç–ª–ª–∏–ø—Å–æ–º‚Äù?</div>
          <div class="hint mt-1">–ö—Ä—É–∂–æ–∫ ‚Äî —ç—Ç–æ video note –≤ –¢–µ–ª–µ–≥–µ, –æ–Ω –∫—Ä—É–≥–ª—ã–π. –≠–ª–ª–∏–ø—Å –æ–±—ã—á–Ω–æ –∏–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –º–∞—Å–∫–∏/–ø—Ä–µ–≤—å—é. –ó–¥–µ—Å—å –º–∞—Å–∫–∞ —Å—Ç—Ä–æ–≥–æ –∫—Ä—É–≥–ª–∞—è.</div>
        </div>
        <div class="card">
          <div class="font-black">–ö–∞–∫ —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
          <div class="hint mt-1">–ü–æ—Å–ª–µ –ª—é–±–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫–æ–º–±–æ (—ç–º–æ–¥–∑–∏+–ø–æ—Å—Ç, 9:16+16:9+–ø–æ—Å—Ç, —Å–µ—Ç–∫–∏+–ø–æ—Å—Ç) –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Telegram init
    // =========================
    const tg = window.Telegram?.WebApp;
    const botUsername = "you_tg_studio_bot"; // –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∫–∏
    const state = {
      tab: "video",
      mode: "circle",
      stripCount: 10,
      file: null,
      fileUrl: null,
      videoEl: null,
      framingByMode: {}, // { mode: {scale, tx, ty} }
      currentFraming: { scale: 1, tx: 0, ty: 0 },
      lastAction: null,
      selectedStyle: "insider",
    };

    function haptic(type="light"){
      try{
        if(tg?.HapticFeedback) tg.HapticFeedback.impactOccurred(type);
      }catch(_){}
    }

    function tgSetup(){
      if(!tg) return;
      tg.ready();
      tg.expand();
      tg.enableClosingConfirmation(); // —É–¥–µ—Ä–∂–∞–Ω–∏–µ: –Ω–µ —É–ª–µ—Ç–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ
      tg.setHeaderColor("#050505");
      tg.setBackgroundColor("#050505");

      const uid = tg.initDataUnsafe?.user?.id || "unknown";
      const ref = `https://t.me/${botUsername}?start=${uid}`;
      document.getElementById("ref-link").textContent = ref;

      document.getElementById("shareBtn").addEventListener("click", () => {
        const text = "üî• CADRART: —Å–¥–µ–ª–∞–π –∫—Ä—É–∂–æ–∫/—ç–º–æ–¥–∑–∏/—Å–µ—Ç–∫—É –∏ –ø–æ—Å—Ç –∑–∞ –º–∏–Ω—É—Ç—É";
        tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(ref)}&text=${encodeURIComponent(text)}`);
      });

      document.getElementById("copyBtn").addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(ref);
          tg.showAlert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
          haptic("medium");
        }catch(_){
          tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
        }
      });
    }
    tgSetup();

    // =========================
    // Tabs
    // =========================
    const tabButtons = document.querySelectorAll(".tab-btn");
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        setTab(btn.dataset.tab);
      });
    });

    function setTab(tab){
      state.tab = tab;
      tabButtons.forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
      ["video","text","partner","manual"].forEach(t => {
        document.getElementById(t+"-section").classList.toggle("hidden", t !== tab);
      });
      haptic();
    }

    // =========================
    // Mode select
    // =========================
    const modeCards = document.querySelectorAll(".mode-card");
    modeCards.forEach(card => {
      card.addEventListener("click", () => {
        const m = card.dataset.mode;
        selectMode(m);
      });
    });

    function selectMode(mode){
      state.mode = mode;
      modeCards.forEach(c => c.classList.toggle("active", c.dataset.mode === mode));

      // strip settings
      const showStrip = (mode === "grid_1xN");
      document.getElementById("stripSettings").classList.toggle("hidden", !showStrip);

      // restore per-mode framing if exists
      state.currentFraming = state.framingByMode[mode] ? {...state.framingByMode[mode]} : {scale: 1, tx: 0, ty: 0};

      updateStatusPill();
      haptic("light");
    }

    function updateStatusPill(){
      const pill = document.getElementById("statusPill");
      const hasFile = !!state.file;
      const modeName = ({
        "circle": "Fake Live",
        "avatar": "Live Avatar",
        "9_16": "9:16",
        "16_9": "16:9",
        "grid_3x3": "Grid 3√ó3",
        "grid_1xN": "Emoji Strip",
        "fx_boomerang": "Boomerang",
        "fx_audio": "MP3",
        "slideshow": "Slideshow"
      })[state.mode] || state.mode;

      pill.textContent = (hasFile ? "‚úÖ " : "‚ö° ") + modeName;
      pill.style.borderColor = hasFile ? "rgba(16,185,129,.45)" : "rgba(255,255,255,.10)";
    }

    // =========================
    // File upload
    // =========================
    const mediaBox = document.getElementById("mediaBox");
    const videoInput = document.getElementById("videoInput");
    const player = document.getElementById("previewPlayer");
    const placeholder = document.getElementById("uploadPlaceholder");
    const fileInfo = document.getElementById("fileInfo");

    mediaBox.addEventListener("click", () => videoInput.click());
    videoInput.addEventListener("change", () => handleFiles(videoInput.files));

    function handleFiles(files){
      if(!files || files.length === 0) return;
      state.file = files[0];
      if(state.fileUrl) URL.revokeObjectURL(state.fileUrl);
      state.fileUrl = URL.createObjectURL(state.file);

      fileInfo.textContent = `${state.file.name} ‚Ä¢ ${(state.file.size/1024/1024).toFixed(1)}MB`;

      if(state.file.type.startsWith("video")){
        placeholder.classList.add("hidden");
        player.classList.remove("hidden");
        player.src = state.fileUrl;
        player.load();
        player.playsInline = true;
        player.muted = true;

        player.onloadedmetadata = () => {
          updateStatusPill();
          // —á—Ç–æ–±—ã –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –±—ã–ª —Å—Ä–∞–∑—É –±–µ–∑ ‚Äú–ø—É—Å—Ç–æ‚Äù
          openPreviewSheet();
        };
      }else{
        // –µ—Å–ª–∏ —Ñ–æ—Ç–æ/–º—É–ª—å—Ç–∏ ‚Äî –¥–ª—è slideshow —Ä–µ–∂–∏–º–æ–≤
        placeholder.classList.remove("hidden");
        player.classList.add("hidden");
        placeholder.innerHTML = `
          <div class="text-4xl mb-2">‚úÖ</div>
          <div class="text-sm font-black">–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${files.length}</div>
          <div class="hint mt-1">–î–ª—è Slideshow –æ—Ç–ø—Ä–∞–≤–ª—è–π —Ñ–æ—Ç–æ ‚Äî –æ—Å—Ç–∞–ª—å–Ω–æ–µ –±–æ—Ç —Å–æ–±–µ—Ä—ë—Ç.</div>
        `;
        updateStatusPill();
      }

      haptic("medium");
    }

    // =========================
    // Bottom —Ä—É–ª–µ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
    // =========================
    const primaryBtn = document.getElementById("primaryBtn");
    const backBtn = document.getElementById("backBtn");
    const previewBtn = document.getElementById("previewBtn");

    backBtn.addEventListener("click", () => {
      // ‚Äú–Ω–∞–∑–∞–¥‚Äù –≤–Ω—É—Ç—Ä–∏ –º–∏–Ω–∏–∞–ø–ø–∞: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ MEDIA –∏–ª–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º sheet
      if(isSheetOpen(previewSheet)) { closePreviewSheet(); return; }
      if(isSheetOpen(helpSheet)) { closeHelpSheet(); return; }
      if(state.tab !== "video") { setTab("video"); return; }
      // –µ—Å–ª–∏ —É–∂–µ –Ω–∞ video ‚Äî –ø—Ä–æ—Å—Ç–æ –ª—ë–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
      haptic("light");
    });

    previewBtn.addEventListener("click", () => {
      openPreviewSheet();
    });

    primaryBtn.addEventListener("click", () => {
      sendVideoTask();
    });

    // =========================
    // Preview sheet / cropper
    // =========================
    const previewSheet = document.getElementById("previewSheet");
    const closeSheetBtn = document.getElementById("closeSheetBtn");
    const openPreviewBtn = document.getElementById("openPreviewBtn");
    const resetFrameBtn = document.getElementById("resetFrameBtn");
    const saveFrameBtn = document.getElementById("saveFrameBtn");

    openPreviewBtn.addEventListener("click", openPreviewSheet);
    closeSheetBtn.addEventListener("click", closePreviewSheet);

    resetFrameBtn.addEventListener("click", () => {
      state.currentFraming = {scale: 1, tx: 0, ty: 0};
      drawCropPreview();
      haptic("light");
    });

    saveFrameBtn.addEventListener("click", () => {
      state.framingByMode[state.mode] = {...state.currentFraming};
      closePreviewSheet();
      haptic("medium");
    });

    function isSheetOpen(el){ return el.classList.contains("open"); }

    function openPreviewSheet(){
      if(!state.file || !state.file.type.startsWith("video")){
        if(tg?.showAlert) tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –≤–∏–¥–µ–æ");
        return;
      }
      applyMaskForMode();
      previewSheet.classList.add("open");
      // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –≤–∏–¥–µ–æ –µ—â—ë –Ω–µ –ø—Ä–æ–≥—Ä—É–∑–∏–ª–æ—Å—å
      setTimeout(() => drawCropPreview(), 30);
      haptic("light");
    }

    function closePreviewSheet(){
      previewSheet.classList.remove("open");
      haptic("light");
    }

    // apply mask for mode
    const maskRect = document.getElementById("maskRect");
    const previewWrap = document.getElementById("previewWrap");
    function applyMaskForMode(){
      // default height
      previewWrap.style.height = "340px";

      maskRect.classList.remove("circle","rect","grid");
      maskRect.classList.add("rect");
      maskRect.style.setProperty("--ar", "16/9");

      if(state.mode === "circle"){
        maskRect.classList.remove("rect");
        maskRect.classList.add("circle");
        previewWrap.style.height = "360px";
      }else if(state.mode === "9_16"){
        maskRect.classList.add("rect");
        maskRect.style.setProperty("--ar", "9/16");
        previewWrap.style.height = "420px";
      }else if(state.mode === "16_9"){
        maskRect.classList.add("rect");
        maskRect.style.setProperty("--ar", "16/9");
        previewWrap.style.height = "320px";
      }else if(state.mode === "grid_3x3"){
        maskRect.classList.remove("rect");
        maskRect.classList.add("grid");
        previewWrap.style.height = "360px";
      }else if(state.mode === "grid_1xN"){
        // –¥–ª—è –ø–æ–ª–æ—Å—ã –ø–æ–∫–∞–∂–µ–º –∫–∞–∫ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ (–æ—Ä–∏–µ–Ω—Ç–∏—Ä), —Ä—É–ª—å —Ç–æ—Ç –∂–µ
        maskRect.classList.add("rect");
        maskRect.style.setProperty("--ar", "16/9");
        previewWrap.style.height = "320px";
      }else if(state.mode === "avatar"){
        maskRect.classList.add("rect");
        maskRect.style.setProperty("--ar", "1/1");
        previewWrap.style.height = "360px";
      }
    }

    // Canvas draw first-frame with transform (pan/zoom)
    const cropCanvas = document.getElementById("cropCanvas");
    const ctx = cropCanvas.getContext("2d", { alpha: false });

    function fitCanvas(){
      const rect = previewWrap.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      cropCanvas.width = Math.floor(rect.width * dpr);
      cropCanvas.height = Math.floor(rect.height * dpr);
      cropCanvas.style.width = rect.width + "px";
      cropCanvas.style.height = rect.height + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    async function drawCropPreview(){
      if(!player || player.readyState < 1) return;

      fitCanvas();

      // draw video frame at currentTime (or 0 if not set)
      try{
        if(isNaN(player.currentTime) || player.currentTime < 0.01) player.currentTime = 0.01;
      }catch(_){}

      const rect = previewWrap.getBoundingClientRect();
      const W = rect.width;
      const H = rect.height;

      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,W,H);

      const vw = player.videoWidth || 1280;
      const vh = player.videoHeight || 720;

      // Base contain
      const contain = Math.min(W / vw, H / vh);
      const baseW = vw * contain;
      const baseH = vh * contain;

      const {scale, tx, ty} = state.currentFraming;

      const drawW = baseW * scale;
      const drawH = baseH * scale;

      const x = (W - drawW)/2 + tx;
      const y = (H - drawH)/2 + ty;

      // draw
      try{
        ctx.drawImage(player, x, y, drawW, drawH);
      }catch(_){
        // –µ—Å–ª–∏ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ –∫–∞–¥—Ä ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º —á—É—Ç—å –ø–æ–∑–∂–µ
        setTimeout(drawCropPreview, 50);
      }
    }

    // touch/gesture: pan + pinch zoom
    let pointers = new Map();
    let gestureStart = null;

    previewWrap.addEventListener("pointerdown", (e) => {
      previewWrap.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
      if(pointers.size === 1){
        gestureStart = {
          mode: "pan",
          startX: e.clientX,
          startY: e.clientY,
          tx: state.currentFraming.tx,
          ty: state.currentFraming.ty,
          scale: state.currentFraming.scale,
        };
      }
      if(pointers.size === 2){
        const pts = [...pointers.values()];
        const dx = pts[0].x - pts[1].x;
        const dy = pts[0].y - pts[1].y;
        const dist = Math.hypot(dx,dy);
        const mid = {x:(pts[0].x+pts[1].x)/2, y:(pts[0].y+pts[1].y)/2};
        gestureStart = {
          mode: "pinch",
          dist,
          mid,
          tx: state.currentFraming.tx,
          ty: state.currentFraming.ty,
          scale: state.currentFraming.scale,
        };
      }
    });

    previewWrap.addEventListener("pointermove", (e) => {
      if(!pointers.has(e.pointerId)) return;
      pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

      if(!gestureStart) return;

      if(gestureStart.mode === "pan" && pointers.size === 1){
        const dx = e.clientX - gestureStart.startX;
        const dy = e.clientY - gestureStart.startY;
        state.currentFraming.tx = gestureStart.tx + dx;
        state.currentFraming.ty = gestureStart.ty + dy;
        drawCropPreview();
      }

      if(gestureStart.mode === "pinch" && pointers.size === 2){
        const pts = [...pointers.values()];
        const dx = pts[0].x - pts[1].x;
        const dy = pts[0].y - pts[1].y;
        const dist = Math.hypot(dx,dy);

        let nextScale = gestureStart.scale * (dist / gestureStart.dist);
        nextScale = Math.max(0.85, Math.min(3.5, nextScale));

        // –ª—ë–≥–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Ü–µ–Ω—Ç—Ä—É (–±–µ–∑ ‚Äú—É–ª—ë—Ç–∞‚Äù)
        state.currentFraming.scale = nextScale;

        drawCropPreview();
      }
    });

    function endPointer(e){
      pointers.delete(e.pointerId);
      if(pointers.size === 0) gestureStart = null;
      if(pointers.size === 1){
        const pt = [...pointers.values()][0];
        gestureStart = {
          mode: "pan",
          startX: pt.x,
          startY: pt.y,
          tx: state.currentFraming.tx,
          ty: state.currentFraming.ty,
          scale: state.currentFraming.scale,
        };
      }
    }
    previewWrap.addEventListener("pointerup", endPointer);
    previewWrap.addEventListener("pointercancel", endPointer);
    window.addEventListener("resize", () => { if(isSheetOpen(previewSheet)) drawCropPreview(); });

    // =========================
    // Emoji strip thumbs (different frames)
    // =========================
    const stripCount = document.getElementById("stripCount");
    const stripCountVal = document.getElementById("stripCountVal");
    const makeThumbsBtn = document.getElementById("makeThumbsBtn");
    const thumbsWrap = document.getElementById("thumbsWrap");
    const thumbsGrid = document.getElementById("thumbsGrid");

    stripCount.addEventListener("input", () => {
      state.stripCount = parseInt(stripCount.value, 10);
      stripCountVal.textContent = state.stripCount;
      haptic("light");
    });

    makeThumbsBtn.addEventListener("click", async () => {
      if(!state.file || !state.file.type.startsWith("video")){
        if(tg?.showAlert) tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –≤–∏–¥–µ–æ");
        return;
      }
      thumbsWrap.classList.remove("hidden");
      thumbsGrid.innerHTML = "";
      await buildThumbs(state.stripCount);
      haptic("medium");
    });

    function waitSeek(v, t){
      return new Promise((resolve) => {
        const onSeeked = () => { v.removeEventListener("seeked", onSeeked); resolve(); };
        v.addEventListener("seeked", onSeeked);
        try{ v.currentTime = Math.min(Math.max(0.01, t), Math.max(0.02, (v.duration||1)-0.02)); }catch(_){ resolve(); }
      });
    }

    async function buildThumbs(n){
      const v = player;
      const dur = v.duration || 6;

      // –æ–≥—Ä–∞–Ω–∏—á–∏–º –¥–æ 20 –∏ –Ω–∞—Ä–∏—Å—É–µ–º –≤ —Å–µ—Ç–∫–µ
      n = Math.max(1, Math.min(20, n));

      // create thumbs
      for(let i=0;i<n;i++){
        const cell = document.createElement("div");
        cell.className = "thumb";
        const c = document.createElement("canvas");
        cell.appendChild(c);
        thumbsGrid.appendChild(cell);

        // time across timeline (different frames!)
        const t = (i + 0.5) / n * dur;

        await waitSeek(v, t);

        // draw into thumb
        const size = 160;
        c.width = size;
        c.height = size;
        const cx = c.getContext("2d");
        cx.fillStyle = "#000";
        cx.fillRect(0,0,size,size);

        const vw = v.videoWidth || 1280;
        const vh = v.videoHeight || 720;

        // cover square
        const cover = Math.max(size/vw, size/vh);
        const dw = vw*cover;
        const dh = vh*cover;
        const dx = (size - dw)/2;
        const dy = (size - dh)/2;
        try{ cx.drawImage(v, dx, dy, dw, dh); }catch(_){}
      }
    }

    // =========================
    // Text styles preview (visual)
    // =========================
    const postPreview = document.getElementById("postPreview");
    document.getElementById("styleList").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-style]");
      if(!btn) return;
      const style = btn.dataset.style;
      state.selectedStyle = style;
      renderPostPreview(style);
      haptic("light");
    });

    function renderPostPreview(style){
      const examples = {
        insider: `üïµÔ∏è <b>–ò–Ω—Å–∞–π–¥ –¥–Ω—è</b>\n\n<b>1.</b> –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ ‚Äú–∫—Ä—É–∂–∫–æ–≤‚Äù –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –∫–∞–¥—Ä–∞.\n<b>2.</b> –†—É–ª—å = –∑—É–º + —Ä–∞–∫—É—Ä—Å ‚Üí —É–¥–µ—Ä–∂–∞–Ω–∏–µ.\n\n<b>–•–æ—á–µ—à—å —à–∞–±–ª–æ–Ω –ø–æ–¥ —Ç–≤–æ—é –Ω–∏—à—É?</b> –ù–∞–ø–∏—à–∏ —Ç–µ–º—É –Ω–∏–∂–µ.`,
        pov: `üëÅÔ∏è POV: —Ç—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –∫—Ä—É–∂–æ–∫‚Ä¶\n\n‚Äî ‚Äú–û, —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ <b>–∂–∏–≤–æ–π —ç—Ñ–∏—Ä</b>‚Äù\n‚Äî ‚Äú–°—Ç–æ–ø, –∞ –∫–∞–∫ –æ–Ω —Ç–∞–∫ –∫–∞–¥—Ä –ø–æ–π–º–∞–ª?‚Äù\n\n–î–∞–π —Ç–µ–º—É ‚Äî —Å–¥–µ–ª–∞—é —Ç–µ–∫—Å—Ç –≤ —Å—Ç–∏–ª–µ Gen Z.`,
        story: `üìñ –ò—Å—Ç–æ—Ä–∏—è:\n\n<b>–ü—Ä–æ–±–ª–µ–º–∞:</b> –≤–∏–¥–µ–æ ‚Äú–≤–ø–∏—Å–∞–ª–æ—Å—å‚Äù –∏ —Å—Ç–∞–ª–æ –º–∞–ª–µ–Ω—å–∫–∏–º.\n<b>–†–µ—à–µ–Ω–∏–µ:</b> –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∫ –≤ Photoshop.\n<b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b> +–≤–æ–≤–ª–µ—á–µ–Ω–∏–µ, +–¥–æ—Å–º–æ—Ç—Ä—ã.\n\n–•–æ—á–µ—à—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–¥ —Ç–≤–æ–π –∫–µ–π—Å?`,
        flash: `‚ö° <b>–¢–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è</b>\n\n‚úÖ –ö—Ä—É–∂–æ–∫ + —ç–º–æ–¥–∑–∏ + –ø–æ—Å—Ç\n‚úÖ 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ç–µ–∫—Å—Ç–∞\n‚úÖ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π\n\n<b>–ñ–º–∏ ‚Äú–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å‚Äù</b> –∏ –∑–∞–±–∏—Ä–∞–π.`,
        aesthetic: `‚ú® <b>–°–µ–≥–æ–¥–Ω—è —Ö–æ—á–µ—Ç—Å—è –∫—Ä–∞—Å–∏–≤–æ</b>\n\n‚Ä¢ –º—è–≥–∫–∏–π —Ç–æ–Ω\n‚Ä¢ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã\n‚Ä¢ ‚Äú–∫–∞–∫ –≤ —Ç–æ–ø-–∫–∞–Ω–∞–ª–∞—Ö‚Äù\n\n–ù–∞–ø–∏—à–∏ —Ç–µ–º—É ‚Äî —Å–¥–µ–ª–∞—é –≤ —Ç–∞–∫–æ–º —Å—Ç–∏–ª–µ.`,
        noir: `üñ§ <b>–ù—É–∞—Ä</b>\n\n–¢–∏—à–∏–Ω–∞.\n–≠–∫—Ä–∞–Ω.\n–ò –∫—Ä—É–∂–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–≥–ª—è–¥–∏—Ç —Å–ª–∏—à–∫–æ–º –∂–∏–≤—ã–º.\n\n–°–∫–∞–∂–∏ —Ç–µ–º—É ‚Äî —Å–¥–µ–ª–∞—é —Ç–µ–∫—Å—Ç –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω–æ.`
      };

      postPreview.innerHTML = `<div class="text-sm leading-6" style="white-space:pre-line">${examples[style] || examples.insider}</div>`;
    }
    renderPostPreview("insider");

    // =========================
    // Combos (send several ‚Äúideas‚Äù quickly)
    // =========================
    document.getElementById("combo1").addEventListener("click", () => {
      setTab("text");
      renderPostPreview(state.selectedStyle);
      if(tg?.showAlert) tg.showAlert("–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –∏ –≤–≤–µ–¥–∏ —Ç–µ–º—É ‚Äî –ø–æ—Ç–æ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ—Å—Ç. –í–∏–¥–µ–æ —É–∂–µ —É —Ç–µ–±—è –≤ MEDIA.");
      haptic("medium");
    });
    document.getElementById("combo2").addEventListener("click", () => {
      selectMode("grid_1xN");
      openPreviewSheet();
      haptic("medium");
    });
    document.getElementById("combo3").addEventListener("click", () => {
      selectMode("9_16");
      openPreviewSheet();
      haptic("medium");
    });

    // =========================
    // Manual quick selects
    // =========================
    document.querySelectorAll("[data-quick]").forEach(b => {
      b.addEventListener("click", () => {
        selectMode(b.dataset.quick);
        setTab("video");
        window.scrollTo({top:0, behavior:"smooth"});
        haptic("light");
      });
    });

    // =========================
    // Help sheet
    // =========================
    const helpSheet = document.getElementById("helpSheet");
    document.getElementById("helpTopBtn").addEventListener("click", () => {
      helpSheet.classList.add("open");
      haptic("light");
    });
    document.getElementById("closeHelpBtn").addEventListener("click", closeHelpSheet);
    function closeHelpSheet(){
      helpSheet.classList.remove("open");
      haptic("light");
    }

    // =========================
    // Send data to bot
    // =========================
    function sendVideoTask(){
      if(!tg){
        alert("–û—Ç–∫—Ä–æ–π –≤ Telegram WebApp");
        return;
      }

      // slideshow: allow photos selection too (multiple)
      if(!state.file){
        tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª");
        return;
      }

      const caption = document.getElementById("videoCaption").value || "";

      let modeToSend = state.mode;

      // Emoji strip: send as grid_1xN (–±–æ—Ç –º–æ–∂–µ—Ç –ø–∞—Ä—Å–∏—Ç—å grid_1x20 –∏ —Ç.–ø.)
      if(modeToSend === "grid_1xN"){
        modeToSend = `grid_1x${state.stripCount}`;
      }

      // attach framing for future server-side crop
      const framing = state.framingByMode[state.mode] || state.currentFraming || {scale:1, tx:0, ty:0};

      const payload = {
        type: "video_setup",
        mode: modeToSend,
        caption,
        framing,           // <-- –≤–∞–∂–Ω–æ–µ: ‚Äú—Ä—É–ª—å‚Äù –∫–∞–¥—Ä–∞
        ui: { brand: "CADRART", v: 3 }
      };

      tg.sendData(JSON.stringify(payload));
      haptic("medium");

      // —É–¥–µ—Ä–∂–∞–Ω–∏–µ: –æ—Å—Ç–∞—ë–º—Å—è –≤ webapp –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ
      try{
        document.getElementById("statusPill").textContent = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚Äî –≤—ã–±–µ—Ä–∏ —Å–ª–µ–¥—É—é—â–∏–π –ø–∞–∫–µ—Ç";
      }catch(_){}
    }

    // Default
    updateStatusPill();

    // Close sheets on backdrop click
    previewSheet.addEventListener("click", (e) => { if(e.target === previewSheet) closePreviewSheet(); });
    helpSheet.addEventListener("click", (e) => { if(e.target === helpSheet) closeHelpSheet(); });
  </script>
</body>
</html>
