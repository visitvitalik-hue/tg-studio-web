<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>CADRART ‚Äî MiniApp</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);

      --bg: #050505;
      --panel: #121212;
      --stroke: rgba(255,255,255,.08);

      --tap: 44px;
      --r: 18px;
    }

    html, body { height: 100%; }
    body{
      font-family: 'Outfit', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 15% 10%, rgba(59,130,246,.18), transparent 40%),
                  radial-gradient(900px 600px at 85% 0%, rgba(245,158,11,.12), transparent 45%),
                  radial-gradient(1200px 800px at 50% 120%, rgba(16,185,129,.10), transparent 40%),
                  var(--bg);
      color: #fff;
      -webkit-tap-highlight-color: transparent;
      min-height: 100dvh;
      padding-top: calc(var(--safe-top) + 8px);
      padding-bottom: calc(var(--safe-bot) + 10px);
      padding-left: calc(var(--safe-left) + 10px);
      padding-right: calc(var(--safe-right) + 10px);
      overflow-x: hidden;
      overscroll-behavior: none;
    }

    input, textarea, select { font-size: 16px; }

    .app{
      max-width: 560px;
      margin: 0 auto;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 60;
      padding-top: 4px;
      backdrop-filter: blur(10px);
      background: rgba(5,5,5,.7);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .tabs{
      display: flex;
      gap: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding: 8px 2px 10px 2px;
    }
    .tabs::-webkit-scrollbar{ display:none; }

    .tab-btn{
      flex: 0 0 auto;
      min-height: var(--tap);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(18,18,18,.75);
      color: rgba(255,255,255,.7);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .5px;
      transition: .18s ease;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .tab-btn.active{
      color:#fff;
      border-color: rgba(59,130,246,.45);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
      background: rgba(18,18,18,.95);
    }

    .card{
      background: rgba(18,18,18,.82);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--r);
      padding: 14px;
    }

    .mode-card{
      background: rgba(18,18,18,.82);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-height: 92px;
      cursor: pointer;
      transition: .16s ease;
      user-select:none;
    }
    .mode-card:active{ transform: scale(.99); }
    .mode-card.active{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
      background: rgba(18,18,18,.95);
    }

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.62);
      line-height: 1.35;
    }

    .label{
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.52);
    }

    .input{
      width:100%;
      background: rgba(10,10,10,.75);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      color:#fff;
      outline:none;
      transition:.15s ease;
    }
    .input:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    .media-box{
      width: 100%;
      height: 220px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
    }
    video{ width:100%; height:100%; object-fit: contain; background:#000; }

    .content{ padding-bottom: 108px; }

    .action-bar{
      position: sticky;
      bottom: 0;
      z-index: 80;
      margin-top: 10px;
      padding: 10px;
      border-radius: 16px;
      backdrop-filter: blur(12px);
      background: rgba(12,12,12,.70);
      border: 1px solid rgba(255,255,255,.10);
    }

    .btn{
      min-height: var(--tap);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      letter-spacing: .02em;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(20,20,20,.85);
      color: #fff;
      transition: .14s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(59,130,246,.70));
      border-color: rgba(59,130,246,.50);
      box-shadow: 0 10px 30px rgba(59,130,246,.18);
    }
    .btn.ghost{ background: rgba(20,20,20,.55); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.72);
    }

    .hidden{ display:none !important; }

    /* Bottom sheet modal (PREVIEW) */
    .sheet{
      position: fixed;
      inset: 0;
      z-index: 120;
      display:none;
      align-items: flex-end;
      justify-content: center;
      padding: 12px;
      padding-bottom: calc(var(--safe-bot) + 12px);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    .sheet.open{ display:flex; }
    .sheet-card{
      width: min(620px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(12,12,12,.92);
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .sheet-head{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .sheet-title{ font-weight: 900; letter-spacing: .02em; }
    .sheet-body{ padding: 14px; }

    .preview-wrap{
      width:100%;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background:#000;
      position: relative;
      touch-action: none;
    }

    .preview-canvas{ width:100%; height:100%; display:block; }

    .mask{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .mask.circle::before{
      content:"";
      width: 78%;
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      box-shadow:
        0 0 0 9999px rgba(0,0,0,.55),
        inset 0 0 0 2px rgba(255,255,255,.18);
    }
    .mask.rect::before{
      content:"";
      width: 86%;
      aspect-ratio: var(--ar, 16/9);
      border-radius: 16px;
      box-shadow:
        0 0 0 9999px rgba(0,0,0,.55),
        inset 0 0 0 2px rgba(255,255,255,.18);
    }
    .mask.grid::before{
      content:"";
      width: 88%;
      aspect-ratio: 1 / 1;
      border-radius: 16px;
      box-shadow:
        0 0 0 9999px rgba(0,0,0,.55),
        inset 0 0 0 2px rgba(255,255,255,.18);
    }
    .gridlines{
      position:absolute;
      width: 88%;
      aspect-ratio: 1/1;
      border-radius: 16px;
      pointer-events:none;
      display:none;
    }
    .mask.grid .gridlines{ display:block; }
    .gridlines::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(to right, transparent 33%, rgba(255,255,255,.16) 33%, rgba(255,255,255,.16) 34%, transparent 34%, transparent 66%, rgba(255,255,255,.16) 66%, rgba(255,255,255,.16) 67%, transparent 67%),
        linear-gradient(to bottom, transparent 33%, rgba(255,255,255,.16) 33%, rgba(255,255,255,.16) 34%, transparent 34%, transparent 66%, rgba(255,255,255,.16) 66%, rgba(255,255,255,.16) 67%, transparent 67%);
      opacity:.8;
      border-radius: 16px;
    }

    @media (min-width: 820px){
      .media-box{ height: 260px; }
      .content{ padding-bottom: 112px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="flex items-center justify-between px-1">
        <div class="flex items-center gap-2">
          <div class="text-sm font-black tracking-wide">CADRART</div>
          <div class="pill" id="statusPill">‚ö° Ready</div>
        </div>
        <button class="btn ghost" style="min-height:40px;padding:8px 12px" id="helpTopBtn">‚ÑπÔ∏è</button>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="video">üé¨ MEDIA</button>
        <button class="tab-btn" data-tab="text">‚úçÔ∏è TEXT</button>
        <button class="tab-btn" data-tab="manual">üß† GUIDE</button>
      </div>
    </div>

    <div class="content">
      <section id="video-section" class="space-y-4">
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <div class="label">–ó–∞–≥—Ä—É–∑–∫–∞</div>
            <div class="hint" id="fileInfo">MP4/MOV/WEBM</div>
          </div>

          <div class="media-box" id="mediaBox">
            <video id="previewPlayer" class="hidden" playsinline></video>
            <div id="uploadPlaceholder" class="text-center px-6">
              <div class="text-4xl mb-2">üì¶</div>
              <div class="text-sm font-black text-white">–ù–∞–∂–º–∏ ‚Äî –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</div>
              <div class="hint mt-1">–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ ‚Äú—Ä—É–ª—å‚Äù –∫–∞–¥—Ä–∞.</div>
            </div>
          </div>

          <input id="videoInput" type="file" accept="video/mp4,video/quicktime,video/webm" class="hidden"/>

          <div class="mt-3 space-y-2">
            <div class="label">–ü–æ–¥–ø–∏—Å—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
            <textarea id="videoCaption" rows="2" class="input" placeholder="–¢–µ–∫—Å—Ç –ø–æ–¥ –≤–∏–¥–µ–æ / –ø–æ—Å—Ç‚Ä¶"></textarea>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between mb-3">
            <div class="label">–†–µ–∂–∏–º</div>
            <button class="btn ghost" style="min-height:40px;padding:8px 12px" id="openPreviewBtn">üëÄ Preview</button>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="mode-card active" data-mode="circle">
              <div class="text-2xl">üîµ</div>
              <div class="font-black text-sm">Fake Live</div>
              <div class="hint">–ö—Ä—É–∂–æ–∫ (video note). –¢—É—Ç –≤–∞–∂–µ–Ω –∫–∞–¥—Ä.</div>
            </div>

            <div class="mode-card" data-mode="avatar">
              <div class="text-2xl">üü£</div>
              <div class="font-black text-sm">Live Avatar</div>
              <div class="hint">HQ –≤–∏–¥–µ–æ-–∞–≤–∞—Ç–∞—Ä (–Ω–µ –∫—Ä—É–∂–æ–∫!).</div>
            </div>

            <div class="mode-card" data-mode="9_16">
              <div class="text-2xl">üì±</div>
              <div class="font-black text-sm">9:16</div>
              <div class="hint">Stories / Reels. –ö–∞–¥—Ä–∏—Ä—É–µ–º.</div>
            </div>

            <div class="mode-card" data-mode="16_9">
              <div class="text-2xl">üñ•Ô∏è</div>
              <div class="font-black text-sm">16:9</div>
              <div class="hint">YouTube / –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å.</div>
            </div>

            <div class="mode-card" data-mode="grid_3x3">
              <div class="text-2xl">üß©</div>
              <div class="font-black text-sm">Grid 3√ó3</div>
              <div class="hint">–°—Ç–∏–∫–µ—Ä-—Å–µ—Ç / –∫–æ–ª–ª–∞–∂.</div>
            </div>

            <div class="mode-card" data-mode="fx_boomerang">
              <div class="text-2xl">‚ôæÔ∏è</div>
              <div class="font-black text-sm">Boomerang</div>
              <div class="hint">–ó–∞–ª–∏–ø–∞–ª–æ–≤–æ.</div>
            </div>

            <div class="mode-card" data-mode="fx_audio">
              <div class="text-2xl">üéµ</div>
              <div class="font-black text-sm">MP3</div>
              <div class="hint">–í—ã—Ç–∞—â–∏—Ç—å –∑–≤—É–∫.</div>
            </div>
          </div>
        </div>
      </section>

      <section id="text-section" class="space-y-4 hidden">
        <div class="card">
          <div class="text-xl font-black">–°—Ç–∏–ª–∏ –ø–æ—Å—Ç–æ–≤</div>
          <div class="hint mt-2">–°–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –ø–æ–¥–∫–ª—é—á–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é + –ø—Ä–µ–≤—å—é —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π/–≤–∏–¥–µ–æ.</div>
        </div>
      </section>

      <section id="manual-section" class="space-y-4 hidden">
        <div class="card">
          <div class="text-xl font-black">Guide</div>
          <div class="hint mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ ‚Üí Preview ‚Üí –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞.</div>
        </div>
      </section>
    </div>

    <div class="action-bar">
      <button class="btn primary w-full" id="primaryBtn">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
      <div class="grid grid-cols-2 gap-2 mt-2">
        <button class="btn ghost" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="btn ghost" id="previewBtn">üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
      </div>
    </div>
  </div>

  <!-- PREVIEW / CROP SHEET -->
  <div class="sheet" id="previewSheet">
    <div class="sheet-card">
      <div class="sheet-head">
        <div>
          <div class="sheet-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä + ‚Äú—Ä—É–ª—å‚Äù –∫–∞–¥—Ä–∞</div>
          <div class="hint">Pinch-zoom –¥–≤—É–º—è –ø–∞–ª—å—Ü–∞–º–∏, drag –æ–¥–Ω–∏–º.</div>
        </div>
        <button class="btn ghost" style="min-height:40px;padding:8px 12px" id="closeSheetBtn">‚úï</button>
      </div>

      <div class="sheet-body space-y-3">
        <div class="preview-wrap" id="previewWrap" style="height: 340px;">
          <canvas id="cropCanvas" class="preview-canvas"></canvas>
          <div class="mask rect" id="maskRect" style="--ar: 16/9;">
            <div class="gridlines"></div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button class="btn ghost" id="resetFrameBtn">‚Ü∫ –°–±—Ä–æ—Å</button>
          <button class="btn primary" id="saveFrameBtn">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>

        <div class="hint">
          ‚Äú–ü—Ä–∏–º–µ–Ω–∏—Ç—å‚Äù —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞. –î–∞–ª—å—à–µ –±–æ—Ç —Å–º–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–æ –≤ ffmpeg.
        </div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    const state = {
      tab: "video",
      mode: "circle",
      file: null,
      fileUrl: null,
      framingByMode: {},
      currentFraming: { scale: 1, tx: 0, ty: 0 },
    };

    function tgInit(){
      if(!tg) return;
      tg.ready();
      tg.expand();
      tg.enableClosingConfirmation();
      tg.setHeaderColor("#050505");
      tg.setBackgroundColor("#050505");
    }
    tgInit();

    function haptic(){
      try{ tg?.HapticFeedback?.impactOccurred("light"); }catch(_){}
    }

    // Tabs
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => setTab(btn.dataset.tab));
    });

    function setTab(tab){
      state.tab = tab;
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
      ["video","text","manual"].forEach(t => {
        document.getElementById(t+"-section").classList.toggle("hidden", t !== tab);
      });
      haptic();
    }

    // Modes
    document.querySelectorAll(".mode-card").forEach(card => {
      card.addEventListener("click", () => selectMode(card.dataset.mode));
    });

    function selectMode(mode){
      state.mode = mode;
      document.querySelectorAll(".mode-card").forEach(c => c.classList.toggle("active", c.dataset.mode === mode));
      state.currentFraming = state.framingByMode[mode] ? {...state.framingByMode[mode]} : {scale:1, tx:0, ty:0};
      updatePill();
      haptic();
    }

    function updatePill(){
      const pill = document.getElementById("statusPill");
      const has = !!state.file;
      pill.textContent = (has ? "‚úÖ " : "‚ö° ") + state.mode;
    }

    // Upload
    const mediaBox = document.getElementById("mediaBox");
    const videoInput = document.getElementById("videoInput");
    const player = document.getElementById("previewPlayer");
    const placeholder = document.getElementById("uploadPlaceholder");
    const fileInfo = document.getElementById("fileInfo");

    mediaBox.addEventListener("click", () => videoInput.click());
    videoInput.addEventListener("change", () => handleFile(videoInput.files?.[0]));

    function handleFile(file){
      if(!file) return;
      state.file = file;
      if(state.fileUrl) URL.revokeObjectURL(state.fileUrl);
      state.fileUrl = URL.createObjectURL(file);
      fileInfo.textContent = `${file.name} ‚Ä¢ ${(file.size/1024/1024).toFixed(1)}MB`;
      placeholder.classList.add("hidden");
      player.classList.remove("hidden");
      player.src = state.fileUrl;
      player.muted = true;
      player.playsInline = true;
      player.load();
      player.onloadedmetadata = () => {
        updatePill();
        openPreview();
      };
    }

    // Bottom buttons
    document.getElementById("backBtn").addEventListener("click", () => {
      if(previewSheet.classList.contains("open")) { closePreview(); return; }
      if(state.tab !== "video") { setTab("video"); return; }
      haptic();
    });

    document.getElementById("previewBtn").addEventListener("click", openPreview);
    document.getElementById("openPreviewBtn").addEventListener("click", openPreview);

    document.getElementById("primaryBtn").addEventListener("click", () => {
      if(!tg){ alert("–û—Ç–∫—Ä–æ–π –≤ Telegram WebApp"); return; }
      if(!state.file){ tg.showAlert?.("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –≤–∏–¥–µ–æ"); return; }
      const caption = document.getElementById("videoCaption").value || "";
      const framing = state.framingByMode[state.mode] || state.currentFraming;

      tg.sendData(JSON.stringify({
        type: "video_setup",
        mode: state.mode,
        caption,
        framing,
        ui: { brand: "CADRART", v: 1 }
      }));
      document.getElementById("statusPill").textContent = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚Äî –≤—ã–±–µ—Ä–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ä–µ–∂–∏–º";
    });

    // Preview/Crop
    const previewSheet = document.getElementById("previewSheet");
    const closeSheetBtn = document.getElementById("closeSheetBtn");
    const resetFrameBtn = document.getElementById("resetFrameBtn");
    const saveFrameBtn = document.getElementById("saveFrameBtn");
    const maskRect = document.getElementById("maskRect");
    const previewWrap = document.getElementById("previewWrap");
    const cropCanvas = document.getElementById("cropCanvas");
    const ctx = cropCanvas.getContext("2d", { alpha: false });

    closeSheetBtn.addEventListener("click", closePreview);
    resetFrameBtn.addEventListener("click", () => { state.currentFraming = {scale:1, tx:0, ty:0}; drawPreview(); });
    saveFrameBtn.addEventListener("click", () => { state.framingByMode[state.mode] = {...state.currentFraming}; closePreview(); });

    function applyMask(){
      maskRect.classList.remove("circle","rect","grid");
      maskRect.classList.add("rect");
      maskRect.style.setProperty("--ar", "16/9");
      previewWrap.style.height = "340px";

      if(state.mode === "circle"){
        maskRect.classList.remove("rect");
        maskRect.classList.add("circle");
        previewWrap.style.height = "360px";
      } else if(state.mode === "9_16"){
        maskRect.classList.add("rect");
        maskRect.style.setProperty("--ar", "9/16");
        previewWrap.style.height = "420px";
      } else if(state.mode === "16_9"){
        maskRect.classList.add("rect");
        maskRect.style.setProperty("--ar", "16/9");
        previewWrap.style.height = "320px";
      } else if(state.mode === "grid_3x3"){
        maskRect.classList.remove("rect");
        maskRect.classList.add("grid");
        previewWrap.style.height = "360px";
      } else if(state.mode === "avatar"){
        maskRect.classList.add("rect");
        maskRect.style.setProperty("--ar", "1/1");
        previewWrap.style.height = "360px";
      }
    }

    function openPreview(){
      if(!state.file){ tg?.showAlert?.("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –≤–∏–¥–µ–æ"); return; }
      applyMask();
      previewSheet.classList.add("open");
      setTimeout(drawPreview, 40);
      haptic();
    }
    function closePreview(){
      previewSheet.classList.remove("open");
      haptic();
    }

    function fitCanvas(){
      const rect = previewWrap.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      cropCanvas.width = Math.floor(rect.width * dpr);
      cropCanvas.height = Math.floor(rect.height * dpr);
      cropCanvas.style.width = rect.width + "px";
      cropCanvas.style.height = rect.height + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    function drawPreview(){
      if(player.readyState < 1) return;
      fitCanvas();

      try{ if(isNaN(player.currentTime) || player.currentTime < 0.01) player.currentTime = 0.01; }catch(_){}

      const rect = previewWrap.getBoundingClientRect();
      const W = rect.width, H = rect.height;
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,W,H);

      const vw = player.videoWidth || 1280;
      const vh = player.videoHeight || 720;

      const contain = Math.min(W / vw, H / vh);
      const baseW = vw * contain;
      const baseH = vh * contain;

      const {scale, tx, ty} = state.currentFraming;
      const drawW = baseW * scale;
      const drawH = baseH * scale;
      const x = (W - drawW)/2 + tx;
      const y = (H - drawH)/2 + ty;

      try{ ctx.drawImage(player, x, y, drawW, drawH); }
      catch(_){ setTimeout(drawPreview, 60); }
    }

    // Drag + Pinch
    let pointers = new Map();
    let gesture = null;

    previewWrap.addEventListener("pointerdown", (e) => {
      previewWrap.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

      if(pointers.size === 1){
        gesture = {type:"pan", sx:e.clientX, sy:e.clientY, tx:state.currentFraming.tx, ty:state.currentFraming.ty, scale:state.currentFraming.scale};
      }
      if(pointers.size === 2){
        const pts = [...pointers.values()];
        const dist = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
        gesture = {type:"pinch", dist, scale:state.currentFraming.scale};
      }
    });

    previewWrap.addEventListener("pointermove", (e) => {
      if(!pointers.has(e.pointerId) || !gesture) return;
      pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

      if(gesture.type === "pan" && pointers.size === 1){
        state.currentFraming.tx = gesture.tx + (e.clientX - gesture.sx);
        state.currentFraming.ty = gesture.ty + (e.clientY - gesture.sy);
        drawPreview();
      }

      if(gesture.type === "pinch" && pointers.size === 2){
        const pts = [...pointers.values()];
        const dist = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
        let nextScale = gesture.scale * (dist / gesture.dist);
        nextScale = Math.max(0.85, Math.min(3.5, nextScale));
        state.currentFraming.scale = nextScale;
        drawPreview();
      }
    });

    function endPointer(e){
      pointers.delete(e.pointerId);
      if(pointers.size === 0) gesture = null;
      if(pointers.size === 1){
        const pt = [...pointers.values()][0];
        gesture = {type:"pan", sx:pt.x, sy:pt.y, tx:state.currentFraming.tx, ty:state.currentFraming.ty, scale:state.currentFraming.scale};
      }
    }
    previewWrap.addEventListener("pointerup", endPointer);
    previewWrap.addEventListener("pointercancel", endPointer);
    window.addEventListener("resize", () => { if(previewSheet.classList.contains("open")) drawPreview(); });

    updatePill();
  </script>
</body>
</html>
