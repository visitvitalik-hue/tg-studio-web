<!--
CADRART MINIAPP v3 ‚Äî ‚Äú—Å—Ç–∞–≤–∏–º –∏ –∫–∞–π—Ñ—É–µ–º‚Äù edition
–§–ò–ö–°–´/–ê–ü–ì–†–ï–ô–î–´:
‚úÖ Zoom —Ç–µ–ø–µ—Ä—å 0.6 ‚Üí 3.0 (–º–æ–∂–Ω–æ –û–¢–î–ê–õ–Ø–¢–¨)
‚úÖ FIT –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å: COVER / CONTAIN (–¥–ª—è 16:9/9:16 –±–æ–ª—å—à–µ –Ω–µ ‚Äú–∫–≤–∞–¥—Ä–∞—Ç–∏–∫ –Ω–∞ –ø–æ–ª–µ‚Äù)
‚úÖ –ö–†–£–ì –≤—Å–µ–≥–¥–∞ –ö–†–£–ì (–Ω–µ —ç–ª–ª–∏–ø—Å) ‚Äî –∏ –æ—Ç–¥–µ–ª—å–Ω–æ:
   - Live Circle (video_note 1:1)
   - Avatar Circle (–ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–π 1:1)
   - Emoji Pack VP9 (webm vp9 –º–∏–Ω–∏-–≤–∏–¥–æ—Å—ã/—ç–º–æ–¥–∑–∏)
‚úÖ –ö–æ–ª–ª–∞–∂/–°–µ—Ç–∫–∞ Random ‚Äî –æ–¥–∏–Ω –∫–ª–∏–∫, –∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–æ–≤–∞—è –∫—Ä–∞—Å–∏–≤–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞
‚úÖ Feed –ø—Ä–µ–≤—å—é ‚Äú–∫–∞–∫ –≤ Telegram‚Äù: –º–µ–¥–∏–∞ + —Ç–µ–∫—Å—Ç-—Å—Ç–∏–ª—å + –º–∏–Ω–∏-–ø–∞–∫ (1..20)
‚úÖ Back/history –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π
LOCAL: –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π —Ñ–∞–π–ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
TG: –≤—Å—Ç–∞–≤—å –∫–∞–∫ WebApp URL.
-->
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>CADRART ‚Äî MiniApp v3</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg0:#05070d; --bg1:#0a0f1f;
    --glass:rgba(255,255,255,.08);
    --stroke:rgba(255,255,255,.14);
    --neon:#00f0ff;
    --accent:#007aff;
    --txt:#fff;
    --mut:rgba(255,255,255,.72);
    --warn:#ff5a5a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;height:100vh;color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial;
    background:radial-gradient(circle at top,var(--bg1),var(--bg0));
    overflow:hidden;
  }
  .wrap{height:100vh;display:flex;flex-direction:column;align-items:center}

  .top{
    width:100%;padding:14px 16px 10px;
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  }
  .brand{display:flex;flex-direction:column;gap:4px}
  .brand .t{font-size:16px;font-weight:1000;letter-spacing:.2px}
  .brand .s{font-size:12px;color:var(--mut);line-height:1.25}
  .pill{
    padding:8px 10px;border-radius:999px;
    border:1px solid var(--stroke);
    background:var(--glass);backdrop-filter:blur(16px);
    font-size:12px;color:var(--mut);
    display:flex;align-items:center;gap:6px;white-space:nowrap;
  }
  .pill b{color:var(--txt)}

  .tabs{
    width:min(92vw,520px);
    display:flex;gap:8px;padding:0 16px 10px;
  }
  .tab{
    flex:1;text-align:center;padding:10px 12px;border-radius:14px;
    border:1px solid var(--stroke);background:var(--glass);
    cursor:pointer;user-select:none;font-size:13px;color:var(--mut);
    transition:.18s;
  }
  .tab.active{
    background:linear-gradient(135deg,var(--neon),var(--accent));
    border-color:transparent;color:#001018;font-weight:1000;
    box-shadow:0 0 22px rgba(0,240,255,.35);
  }

  /* Stage */
  .stage{
    width:min(92vw,520px);
    aspect-ratio:1/1;border-radius:18px;position:relative;overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
    background:linear-gradient(145deg,#0a0a0a,#111);
    box-shadow:0 0 45px rgba(0,240,255,.14), inset 0 0 22px rgba(255,255,255,.06);
  }
  .viewport{position:absolute;inset:0;overflow:hidden}
  .video-layer{
    position:absolute;left:50%;top:50%;
    transform:translate(-50%,-50%) scale(1);
    transform-origin:center center;will-change:transform;
    filter:contrast(1.06) saturate(1.10);
  }
  video{display:block;width:auto;height:100%}

  .mask{position:absolute;inset:0;pointer-events:none}
  .mask.circle::after{
    content:"";position:absolute;inset:0;border-radius:50%;
    box-shadow:0 0 0 999px rgba(0,0,0,.60);
    border:2px solid rgba(0,240,255,.85);
  }
  .mask.avatar::after{
    content:"";position:absolute;inset:0;border-radius:22px;
    box-shadow:0 0 0 999px rgba(0,0,0,.60);
    border:2px solid rgba(0,240,255,.65);
  }
  .mask.grid{display:grid;border:2px solid rgba(0,240,255,.55)}
  .mask.grid .cell{border:1px dashed rgba(0,240,255,.30)}
  .mask.ratio916::after{
    content:"";position:absolute;inset:0;
    --w:56%;
    left:calc((100% - var(--w))/2);width:var(--w);
    border-radius:18px;
    box-shadow:0 0 0 999px rgba(0,0,0,.60);
    border:2px solid rgba(0,240,255,.65);
  }
  .mask.ratio169::after{
    content:"";position:absolute;
    --h:56%;
    top:calc((100% - var(--h))/2);height:var(--h);
    left:0;right:0;border-radius:18px;
    box-shadow:0 0 0 999px rgba(0,0,0,.60);
    border:2px solid rgba(0,240,255,.65);
  }

  /* Modes row */
  .modes{
    width:min(92vw,520px);
    display:flex;gap:10px;overflow-x:auto;padding:10px 16px;
    scrollbar-width:none;
  }
  .card{
    min-width:170px;padding:12px;border-radius:16px;
    border:1px solid var(--stroke);background:var(--glass);
    backdrop-filter:blur(16px);cursor:pointer;transition:.18s;
  }
  .card.active{
    background:linear-gradient(135deg, rgba(0,240,255,.18), rgba(0,122,255,.14));
    border-color:rgba(0,240,255,.30);
    box-shadow:0 0 18px rgba(0,240,255,.18);
  }
  .card .h{font-size:13px;font-weight:1000}
  .card .d{margin-top:6px;font-size:11px;color:var(--mut);line-height:1.25}
  .card .tag{
    display:inline-block;margin-top:10px;padding:5px 8px;border-radius:999px;
    font-size:11px;color:rgba(255,255,255,.86);
    border:1px solid rgba(255,255,255,.14);
  }

  /* Controls */
  .panel{
    width:min(92vw,520px);
    padding:10px 16px;display:flex;gap:10px;align-items:center;
  }
  .panel .lbl{width:64px;font-size:12px;color:var(--mut)}
  input[type="range"]{width:100%}
  .row{
    width:min(92vw,520px);
    padding:0 16px 10px;
    display:flex;gap:10px;
  }
  .btn{
    flex:1;text-align:center;padding:12px;border-radius:14px;
    border:1px solid var(--stroke);background:var(--glass);color:var(--txt);
    cursor:pointer;user-select:none;backdrop-filter:blur(16px);font-weight:1000;
  }
  .btn.primary{
    background:linear-gradient(135deg,var(--neon),var(--accent));
    color:#001018;border-color:transparent;
    box-shadow:0 0 24px rgba(0,240,255,.30);
  }
  .btn.warn{background:rgba(255,90,90,.14);border-color:rgba(255,90,90,.35)}
  .btn.mini{font-size:12px;font-weight:900}
  .btn:active{transform:scale(.99)}

  .toggle{
    display:flex;gap:8px;align-items:center;
    width:min(92vw,520px);padding:0 16px 10px;
  }
  .seg{
    flex:1;display:flex;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);border-radius:14px;overflow:hidden;
  }
  .seg button{
    flex:1;border:0;background:transparent;color:rgba(255,255,255,.75);
    padding:10px 10px;font-weight:1000;cursor:pointer;
  }
  .seg button.active{
    background:linear-gradient(135deg, rgba(0,240,255,.22), rgba(0,122,255,.18));
    color:#dffcff;
  }
  .hintLine{
    width:min(92vw,520px);padding:0 16px 10px;
    font-size:12px;color:var(--mut);line-height:1.25;
  }

  /* Upload */
  .upload{margin-top:auto;margin-bottom:10px}
  .upload label{
    display:inline-block;padding:14px 22px;border-radius:18px;font-weight:1000;cursor:pointer;
    background:linear-gradient(135deg,var(--neon),var(--accent));
    box-shadow:0 0 26px rgba(0,240,255,.28);color:#001018;
  }
  input[type="file"]{display:none}

  /* Feed */
  .sheet{
    width:min(92vw,520px);
    margin:0 0 10px;padding:12px 14px;border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.20);backdrop-filter:blur(16px);
  }
  .sheet .title{font-size:12px;color:var(--mut);margin-bottom:8px;line-height:1.25}
  .combo{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    padding:8px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06);
    font-size:12px;cursor:pointer;
  }
  .chip b{color:var(--neon)}
  .feed{
    width:min(92vw,520px);
    padding:10px 16px 12px;
    overflow:auto;
    max-height:calc(100vh - 540px);
  }
  .post{
    border-radius:18px;border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.16);backdrop-filter:blur(16px);
    overflow:hidden;margin-bottom:12px;
    box-shadow:0 14px 40px rgba(0,0,0,.35);
  }
  .postHdr{
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);
  }
  .chan{display:flex;align-items:center;gap:10px}
  .ava{
    width:34px;height:34px;border-radius:50%;
    background:linear-gradient(135deg, rgba(0,240,255,.35), rgba(0,122,255,.25));
    border:1px solid rgba(255,255,255,.14);box-shadow:0 0 16px rgba(0,240,255,.18);
  }
  .chan .nm{font-weight:1000;font-size:13px}
  .chan .tm{font-size:11px;color:var(--mut);margin-top:2px}
  .dot{font-size:18px;opacity:.7}

  .media{position:relative;background:#000}
  .media canvas{
    display:block;width:100%;height:auto;
    /* –≤–∞–∂–Ω–æ–µ: –Ω–µ –¥–∞—ë–º —Ä–∞—Å—Ç—è–∂–∫–∏, –∫—Ä—É–≥ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∫—Ä—É–≥–æ–º */
  }
  .mediaBadge{
    position:absolute;left:10px;top:10px;
    padding:6px 10px;border-radius:999px;
    background:rgba(0,0,0,.42);
    border:1px solid rgba(255,255,255,.12);
    font-size:11px;color:rgba(255,255,255,.92);
    backdrop-filter:blur(12px);
  }
  .mediaCta{
    position:absolute;right:10px;bottom:10px;
    padding:10px 12px;border-radius:14px;
    background:linear-gradient(135deg,var(--neon),var(--accent));
    color:#001018;font-weight:1000;font-size:12px;
    box-shadow:0 0 22px rgba(0,240,255,.30);
    cursor:pointer;user-select:none;
  }
  .postBody{padding:10px 12px 12px}
  .postText{font-size:13px;line-height:1.35;white-space:pre-wrap}
  .postText b{font-weight:1000}
  .postText i{opacity:.95}

  .miniPack{
    margin-top:10px;display:flex;gap:6px;overflow-x:auto;
    padding-bottom:4px;scrollbar-width:none;
  }
  .miniPack .m{
    width:42px;min-width:42px;height:42px;border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    overflow:hidden;background:#000;box-shadow:0 8px 18px rgba(0,0,0,.35);
  }
  .miniPack .m.round{border-radius:50%}
  .miniPack .m canvas{width:100%;height:100%}

  .postActions{display:flex;gap:8px;margin-top:12px}
  .act{
    flex:1;text-align:center;padding:10px 10px;border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    cursor:pointer;font-size:12px;font-weight:1000;
  }
  .act.primary{
    background:linear-gradient(135deg, rgba(0,240,255,.22), rgba(0,122,255,.18));
    border-color:rgba(0,240,255,.24);
  }

  .hide{display:none !important}
</style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="t">CADRART</div>
      <div class="s">–ö–∞–¥—Ä ‚Üí –ü–∞–∫ ‚Üí –ü–æ—Å—Ç. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø—Ä–µ–≤—å—é: 16:9 / 9:16 / –∫–æ–ª–ª–∞–∂–∏ / —Å–µ—Ç–∫–∏ / —ç–º–æ–¥–∑–∏-–ø–∞–∫–∏.</div>
    </div>
    <div class="pill" id="statusPill">üü¶ <b>–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º</b></div>
  </div>

  <div class="tabs">
    <div class="tab active" id="tabEdit">üé¨ –†–∞–∫—É—Ä—Å</div>
    <div class="tab" id="tabFeed">üß† –ü—Ä–µ–≤—å—é-–ø–æ—Å—Ç—ã</div>
    <div class="tab" id="tabCombo">üé≤ Random</div>
  </div>

  <div class="stage" id="stage">
    <div class="viewport" id="viewport">
      <div class="video-layer" id="layer">
        <video id="vid" muted playsinline loop></video>
      </div>
    </div>
    <div class="mask circle" id="mask"></div>
  </div>

  <!-- EDIT -->
  <div id="paneEdit">
    <div class="modes" id="modesRow"></div>

    <div class="toggle">
      <div class="seg" style="flex:1">
        <button id="fitCover" class="active">FIT: COVER</button>
        <button id="fitContain">FIT: CONTAIN</button>
      </div>
      <div class="seg" style="max-width:180px">
        <button id="pack12" class="active">–ü–∞–∫ 12</button>
        <button id="pack20">–ü–∞–∫ 20</button>
      </div>
    </div>

    <div class="panel">
      <div class="lbl">Zoom</div>
      <input type="range" id="zoom" min="0.6" max="3.0" value="1" step="0.01"/>
    </div>

    <div class="hintLine">
      <b>–°–æ–≤–µ—Ç:</b> –¥–ª—è 16:9 / 9:16 —Å—Ç–∞–≤—å <b>CONTAIN</b>, —á—Ç–æ–±—ã ‚Äú–Ω–µ –±—ã–ª–æ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∞‚Äù –∏ –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–¥–∞–ª–∏—Ç—å (0.6‚Äì0.9).
      –î–ª—è –∫—Ä—É–∂–∫–∞/–∞–≤–∞—Ç–∞—Ä–∞ –æ–±—ã—á–Ω–æ –ª—É—á—à–µ <b>COVER</b>.
    </div>

    <div class="row">
      <div class="btn mini" id="btnCenter">üéØ –¶–µ–Ω—Ç—Ä</div>
      <div class="btn mini" id="btnMakeFeed">üß† –°–¥–µ–ª–∞—Ç—å –ø—Ä–µ–≤—å—é</div>
      <div class="btn primary" id="btnSend">üöÄ –í –±–æ—Ç–∞</div>
    </div>

    <div class="sheet">
      <div class="title">
        –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫—Ä—É–≥–æ–≤:
        <b>Live Circle</b> ‚Äî ‚Äú–∫–∞–∫ –±—É–¥—Ç–æ –æ–Ω–ª–∞–π–Ω‚Äù (video_note 1:1).
        <b>Avatar Circle</b> ‚Äî –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–π (mp4 1:1).
        <b>Emoji Pack VP9</b> ‚Äî –º–∏–Ω–∏-–≤–∏–¥–æ—Å—ã (webm vp9).
      </div>
      <div class="combo">
        <div class="chip" id="chipExplain"><b>–ß—Ç–æ –∫—É–¥–∞?</b></div>
        <div class="chip" id="chipRandLayout"><b>–ö–æ–ª–ª–∞–∂/–°–µ—Ç–∫–∞ random</b> üé≤</div>
      </div>
    </div>
  </div>

  <!-- FEED -->
  <div id="paneFeed" class="hide">
    <div class="sheet">
      <div class="title">
        –≠—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ <b>–≥–æ—Ç–æ–≤—ã–π –ø–æ—Å—Ç</b>. –ù–∞–∂–∏–º–∞–π ‚Äú–°–æ–±—Ä–∞—Ç—å —Ç–∞–∫ –∂–µ‚Äù ‚Äî –≤ –±–æ—Ç–∞ —É–π–¥—É—Ç: —Ä–µ–∂–∏–º + —Ä–∞–∫—É—Ä—Å + zoom + FIT + –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å.
      </div>
      <div class="combo">
        <div class="chip" id="chipNewFeed"><b>–ï—â—ë 3 –ø–æ—Å—Ç–∞</b> ‚ú®</div>
        <div class="chip" id="chipShuffleStyles"><b>–°–º–µ–Ω–∏—Ç—å –≤–∞–π–±</b></div>
        <div class="chip" id="chipSwitchFit"><b>–ü–µ—Ä–µ–∫–ª. FIT</b></div>
      </div>
    </div>

    <div class="feed" id="feed"></div>

    <div class="row" style="padding-bottom:12px">
      <div class="btn warn" id="btnBackToEdit">‚Ü© –†–∞–∫—É—Ä—Å</div>
      <div class="btn primary" id="btnFeedToBot">üöÄ –í –±–æ—Ç–∞</div>
    </div>
  </div>

  <!-- RANDOM / COMBO -->
  <div id="paneCombo" class="hide">
    <div class="sheet">
      <div class="title">
        –ó–¥–µ—Å—å ‚Äî –±—ã—Å—Ç—Ä—ã–µ ‚Äú–≤–∞—É‚Äù —Ä–∞—Å–∫–ª–∞–¥–∫–∏. –û–¥–∏–Ω –∫–ª–∏–∫ ‚Üí –Ω–æ–≤–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–µ–≤—å—é-–ø–æ—Å—Ç–µ.
      </div>
      <div class="combo">
        <div class="chip" id="chipRandomNow"><b>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</b> üé≤</div>
        <div class="chip" id="chipGoFeed"><b>–ü–æ–∫–∞–∑–∞—Ç—å –≤ –ª–µ–Ω—Ç–µ</b> üß†</div>
        <div class="chip" id="chipBackEdit"><b>–ù–∞–∑–∞–¥</b></div>
      </div>
    </div>

    <div class="sheet">
      <div class="title">–ß—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏–ª–∏: <span id="randInfo" style="color:var(--neon)"></span></div>
      <div class="hintLine" style="padding:0">
        –¢—É—Ç –∏–¥–µ—è –ø—Ä–æ—Å—Ç–∞—è: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫—Ä–∞—Å–æ—Ç—É ‚Üí –∂–º—ë—Ç ‚Äú—Å–æ–±—Ä–∞—Ç—å‚Äù ‚Üí –º—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –µ—â—ë –æ–¥–∏–Ω –ø–∞–∫–µ—Ç.
      </div>
    </div>
  </div>

  <div class="upload">
    <label>üìÇ –í—ã–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ
      <input type="file" id="file" accept="video/*">
    </label>
  </div>

</div>

<script>
/* ---------- Telegram wrapper (works locally) ---------- */
const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
const pill = document.getElementById("statusPill");
(function initTG(){
  if(tg){ tg.expand(); pill.innerHTML="üü© <b>Telegram —Ä–µ–∂–∏–º</b>"; }
  else { pill.innerHTML="üü¶ <b>–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º</b>"; }
})();

function tgSendData(payload){
  if(tg && tg.sendData){
    tg.sendData(JSON.stringify(payload));
    tg.showPopup && tg.showPopup({
      title:"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ",
      message:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—à–ª–∏ –≤ –±–æ—Ç–∞. –¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∑–∏ –≤–∏–¥–µ–æ –≤ —á–∞—Ç ‚Äî –∏ –ø–æ–ª—É—á–∏—à—å —Ä–µ–Ω–¥–µ—Ä.",
      buttons:[{type:"ok"}]
    });
  } else {
    console.log("LOCAL sendData payload:", payload);
    alert("LOCAL: payload –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–æ—Ç–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12).");
  }
}

/* ---------- Core elements ---------- */
const stage = document.getElementById("stage");
const viewport = document.getElementById("viewport");
const layer = document.getElementById("layer");
const vid = document.getElementById("vid");
const mask = document.getElementById("mask");
const file = document.getElementById("file");
const zoom = document.getElementById("zoom");
const feedEl = document.getElementById("feed");

/* ---------- Tabs ---------- */
const tabEdit = document.getElementById("tabEdit");
const tabFeed = document.getElementById("tabFeed");
const tabCombo = document.getElementById("tabCombo");
const paneEdit = document.getElementById("paneEdit");
const paneFeed = document.getElementById("paneFeed");
const paneCombo = document.getElementById("paneCombo");

function setTab(which){
  [tabEdit,tabFeed,tabCombo].forEach(t=>t.classList.remove("active"));
  [paneEdit,paneFeed,paneCombo].forEach(p=>p.classList.add("hide"));

  if(which==="edit"){ tabEdit.classList.add("active"); paneEdit.classList.remove("hide"); }
  if(which==="feed"){ tabFeed.classList.add("active"); paneFeed.classList.remove("hide"); }
  if(which==="combo"){ tabCombo.classList.add("active"); paneCombo.classList.remove("hide"); }

  if(which==="feed"){
    const used = stage.getBoundingClientRect().bottom + 210;
    const h = Math.max(180, window.innerHeight - used);
    feedEl.style.maxHeight = h + "px";
  }
}
tabEdit.onclick=()=>setTab("edit");
tabFeed.onclick=()=>setTab("feed");
tabCombo.onclick=()=>setTab("combo");

/* ---------- State ---------- */
let mode = "live_circle";         // distinct modes
let lastMode = "live_circle";
let fit = "cover";                // cover | contain
let packSize = 12;

let framing = { x:0, y:0, z:1 };
let dragging=false;
let start = {x:0,y:0,ox:0,oy:0};

let randomLayoutName = "";

/* ---------- FIT toggle ---------- */
const fitCover = document.getElementById("fitCover");
const fitContain = document.getElementById("fitContain");
function setFit(v){
  fit=v;
  fitCover.classList.toggle("active", fit==="cover");
  fitContain.classList.toggle("active", fit==="contain");
}
fitCover.onclick=()=>setFit("cover");
fitContain.onclick=()=>setFit("contain");

/* ---------- Pack size toggle ---------- */
const pack12 = document.getElementById("pack12");
const pack20 = document.getElementById("pack20");
function setPack(n){
  packSize=n;
  pack12.classList.toggle("active", packSize===12);
  pack20.classList.toggle("active", packSize===20);
}
pack12.onclick=()=>setPack(12);
pack20.onclick=()=>setPack(20);

/* ---------- Masks ---------- */
function applyMask(kind){
  mask.className="mask";
  mask.innerHTML="";
  if(kind==="circle"){ mask.classList.add("circle"); return; }
  if(kind==="avatar"){ mask.classList.add("avatar"); return; }
  if(kind==="ratio916"){ mask.classList.add("ratio916"); return; }
  if(kind==="ratio169"){ mask.classList.add("ratio169"); return; }
  if(kind==="grid3"){
    mask.classList.add("grid");
    mask.style.gridTemplateColumns="repeat(3,1fr)";
    mask.style.gridTemplateRows="repeat(3,1fr)";
    for(let i=0;i<9;i++){ const d=document.createElement("div"); d.className="cell"; mask.appendChild(d); }
    return;
  }
  if(kind==="grid20"){
    mask.classList.add("grid");
    mask.style.gridTemplateColumns="repeat(20,1fr)";
    mask.style.gridTemplateRows="repeat(1,1fr)";
    for(let i=0;i<20;i++){ const d=document.createElement("div"); d.className="cell"; mask.appendChild(d); }
    return;
  }
}

/* ---------- Modes (separate Live/Avatar/EmojiPack + Random Collage/Grid) ---------- */
const MODES = [
  { key:"live_circle",   title:"‚óè Live Circle",   desc:"–ö—Ä—É–∂–æ–∫ ¬´—è –æ–Ω–ª–∞–π–Ω¬ª (video_note 1:1).", tag:"TG live", mask:"circle", render:"circle_live_mp4" },
  { key:"avatar_circle", title:"üë§ Avatar Circle", desc:"–ö—Ä—É–∂–æ–∫ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è (mp4 1:1).",      tag:"–ø—Ä–æ—Ñ–∏–ª—å", mask:"avatar", render:"circle_avatar_mp4" },
  { key:"emoji_pack",    title:"üßø Emoji Pack VP9",desc:"–ú–∏–Ω–∏-–≤–∏–¥–æ—Å—ã (webm vp9) ‚Äî –∫–∞–∫ —ç–º–æ–¥–∑–∏.",tag:"vp9 webm",mask:"circle", render:"emoji_vp9_pack" },
  { key:"9_16",          title:"üì± 9:16",          desc:"Shorts/Reels/Stories. –õ—É—á—à–µ FIT=CONTAIN.", tag:"–≤–µ—Ä—Ç–∏–∫–∞–ª—å", mask:"ratio916", render:"9_16" },
  { key:"16_9",          title:"üñ• 16:9",          desc:"YouTube/–æ–±–ª–æ–∂–∫–∞/–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏. FIT=CONTAIN.", tag:"–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å", mask:"ratio169", render:"16_9" },
  { key:"grid_3x3",      title:"üß© 3√ó3",           desc:"–ü–∞–∫ —ç–º–æ—Ü–∏–π/—Ä–∞–∫—É—Ä—Å–æ–≤. –ú–æ–∂–Ω–æ –∫—Ä—É–≥/–∫–≤–∞–¥—Ä–∞—Ç –≤ –ø–∞–∫–µ.", tag:"–ø–∞–∫", mask:"grid3", render:"grid_3x3" },
  { key:"grid_20x1",     title:"üßµ 20√ó1",          desc:"–õ–µ–Ω—Ç–∞ —ç–º–æ–¥–∑–∏/—Å—Ç–∏–∫–µ—Ä–æ–≤. FIT –≤–ª–∏—è–µ—Ç –Ω–∞ –∫–∞–¥—Ä.", tag:"–º–Ω–æ–≥–æ", mask:"grid20", render:"grid_20x1" },
  { key:"rand_layout",   title:"üé≤ Random Layout", desc:"–ö–æ–ª–ª–∞–∂/—Å–µ—Ç–∫–∞/–±–∞–Ω–Ω–µ—Ä ‚Äî –æ–¥–∏–Ω –∫–ª–∏–∫, –Ω–æ–≤–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞.", tag:"–≤–∞—É", mask:"avatar", render:"collage_random" },
];

const modesRow = document.getElementById("modesRow");
function renderModes(){
  modesRow.innerHTML="";
  MODES.forEach(m=>{
    const c=document.createElement("div");
    c.className="card"+(m.key===mode?" active":"");
    c.dataset.key=m.key;
    c.innerHTML = `
      <div class="h">${m.title}</div>
      <div class="d">${m.desc}</div>
      <div class="tag">${m.tag}</div>
    `;
    c.onclick=()=>{
      if(m.key==="rand_layout"){
        setMode("rand_layout");
        doRandomLayout(true);
        setTab("combo");
        return;
      }
      setMode(m.key);
    };
    modesRow.appendChild(c);
  });
}
function highlightMode(key){
  [...modesRow.querySelectorAll(".card")].forEach(x=>x.classList.toggle("active", x.dataset.key===key));
}
function setMode(key){
  const m = MODES.find(x=>x.key===key);
  if(!m) return;
  lastMode = mode;
  mode = key;
  applyMask(m.mask);
  highlightMode(key);
}
renderModes();
setMode("live_circle");

/* ---------- Transform (drag/zoom) ---------- */
function applyTransform(){
  layer.style.transform = `translate(calc(-50% + ${framing.x}px), calc(-50% + ${framing.y}px)) scale(${framing.z})`;
}
applyTransform();

/* Drag */
viewport.addEventListener("pointerdown",(e)=>{
  if(!vid.src) return;
  dragging=true;
  viewport.setPointerCapture(e.pointerId);
  start.x=e.clientX; start.y=e.clientY;
  start.ox=framing.x; start.oy=framing.y;
});
viewport.addEventListener("pointermove",(e)=>{
  if(!dragging) return;
  framing.x = start.ox + (e.clientX - start.x);
  framing.y = start.oy + (e.clientY - start.y);
  applyTransform();
});
viewport.addEventListener("pointerup",()=>dragging=false);
viewport.addEventListener("pointercancel",()=>dragging=false);

/* Zoom */
zoom.addEventListener("input",()=>{
  framing.z = parseFloat(zoom.value);
  applyTransform();
});

/* Center */
document.getElementById("btnCenter").onclick=()=>{
  framing.x=0; framing.y=0;
  framing.z=parseFloat(zoom.value)||1;
  applyTransform();
};

/* ---------- Video loading ---------- */
file.addEventListener("change",(e)=>{
  const f=e.target.files[0];
  if(!f) return;
  const url=URL.createObjectURL(f);
  vid.src=url;
  vid.play().catch(()=>{});
  applyTransform();
});

/* ---------- Normalized framing for bot ---------- */
function normalizedFraming(){
  const rect = stage.getBoundingClientRect();
  return {
    nx: framing.x / rect.width,
    ny: framing.y / rect.height,
    zoom: framing.z,
    fit: fit
  };
}
function resolveRenderMode(){
  const m = MODES.find(x=>x.key===mode);
  return m ? m.render : "circle_live_mp4";
}

/* ---------- Capture base canvas (first frame) WITH FIT logic ---------- */
async function ensureFirstFrame(){
  if(!vid.src) return false;
  if(vid.readyState>=2) return true;
  await new Promise(res=>{
    const on=()=>{ vid.removeEventListener("loadeddata",on); res(); };
    vid.addEventListener("loadeddata",on);
  });
  return true;
}

async function captureBaseCanvas(size=900){
  const ok = await ensureFirstFrame();
  const base=document.createElement("canvas");
  base.width=size; base.height=size;
  const ctx=base.getContext("2d");
  ctx.fillStyle="#000"; ctx.fillRect(0,0,size,size);

  if(!ok){
    ctx.fillStyle="rgba(255,255,255,.85)";
    ctx.font="1000 18px system-ui";
    ctx.fillText("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –≤–∏–¥–µ–æ", 20, 40);
    return base;
  }

  const vw = vid.videoWidth || 1;
  const vh = vid.videoHeight || 1;

  // FIT logic:
  // cover => max (fills square, crops)
  // contain => min (fits inside square, may have letterbox)
  const kCover = Math.max(size/vw, size/vh);
  const kContain = Math.min(size/vw, size/vh);
  const k = (fit==="contain") ? kContain : kCover;

  const sx = vw * k;
  const sy = vh * k;

  // zoom multiplies after fit
  const cx = size/2 + framing.x;
  const cy = size/2 + framing.y;

  ctx.save();
  ctx.translate(cx, cy);
  ctx.scale(framing.z, framing.z);
  ctx.drawImage(vid, -sx/2, -sy/2, sx, sy);
  ctx.restore();

  // gentle grade
  ctx.save();
  ctx.globalAlpha=0.10;
  ctx.fillStyle="#00f0ff";
  ctx.fillRect(0,0,size,size);
  ctx.restore();

  return base;
}

/* ---------- Canvas helpers (ratios + collages) ---------- */
function cropFrom(base, w, h, sx, sy, sw, sh){
  const c=document.createElement("canvas");
  c.width=w; c.height=h;
  const ctx=c.getContext("2d");
  ctx.drawImage(base, sx, sy, sw, sh, 0,0,w,h);
  return c;
}
function makeCanvas_16x9(base){
  const s=base.width;
  const targetW=960, targetH=Math.round(targetW*9/16);
  const cropH=Math.round(s*9/16);
  return cropFrom(base, targetW, targetH, 0, (s-cropH)/2, s, cropH);
}
function makeCanvas_9x16(base){
  const s=base.width;
  const targetH=960, targetW=Math.round(targetH*9/16);
  const cropW=Math.round(s*9/16);
  return cropFrom(base, targetW, targetH, (s-cropW)/2, 0, cropW, s);
}
function makeCanvas_19x6(base){
  const s=base.width;
  const targetW=1140, targetH=Math.round(targetW*6/19);
  const cropH=Math.round(s*6/19);
  return cropFrom(base, targetW, targetH, 0, (s-cropH)/2, s, cropH);
}
function makeCanvas_circle(base){
  // –ñ–ï–õ–ï–ó–ù–û –∫—Ä—É–≥: –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π canvas + circle clip
  const size=720;
  const c=document.createElement("canvas");
  c.width=size; c.height=size;
  const ctx=c.getContext("2d");
  ctx.fillStyle="#000"; ctx.fillRect(0,0,size,size);

  ctx.save();
  ctx.beginPath();
  ctx.arc(size/2,size/2,size/2-10,0,Math.PI*2);
  ctx.clip();
  ctx.drawImage(base, 0,0, base.width, base.height, 0,0,size,size);
  ctx.restore();

  ctx.strokeStyle="rgba(0,240,255,.85)";
  ctx.lineWidth=5;
  ctx.beginPath();
  ctx.arc(size/2,size/2,size/2-12,0,Math.PI*2);
  ctx.stroke();
  return c;
}
function makeCanvas_split(base){
  const w=1024, h=576;
  const c=document.createElement("canvas"); c.width=w; c.height=h;
  const ctx=c.getContext("2d");
  ctx.fillStyle="#000"; ctx.fillRect(0,0,w,h);

  ctx.drawImage(base, 0,0, base.width, base.height, -50, -30, w/2+150, h+80);
  ctx.globalAlpha=0.96;
  ctx.drawImage(base, 0,0, base.width, base.height, w/2-90, -15, w/2+170, h+50);
  ctx.globalAlpha=1;

  ctx.fillStyle="rgba(255,255,255,.14)";
  ctx.fillRect(w/2-1,0,2,h);
  return c;
}
function makeCanvas_mosaic(base){
  const w=1024, h=576;
  const c=document.createElement("canvas"); c.width=w; c.height=h;
  const ctx=c.getContext("2d");
  ctx.fillStyle="#000"; ctx.fillRect(0,0,w,h);

  ctx.drawImage(base, 0,0, base.width, base.height, -70, -40, 660, 660);

  const tileW=364, tileH=192;
  for(let i=0;i<3;i++){
    const jx=(i-1)*14, jy=(1-i)*10;
    ctx.drawImage(base, 0,0, base.width, base.height, 660+jx, i*tileH+jy, tileW, tileH);
  }

  ctx.strokeStyle="rgba(255,255,255,.14)";
  ctx.lineWidth=2;
  ctx.strokeRect(0,0,w,h);
  ctx.beginPath(); ctx.moveTo(660,0); ctx.lineTo(660,h); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(660,192); ctx.lineTo(w,192); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(660,384); ctx.lineTo(w,384); ctx.stroke();
  return c;
}
function makeCanvas_gridCollage(base){
  // ‚Äú–∫–æ–ª–ª–∞–∂—Å–µ—Ç–∫–∞‚Äù: 3√ó3, –Ω–æ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫—Ä–æ–ø–∞–º–∏
  const w=1024, h=1024;
  const c=document.createElement("canvas"); c.width=w; c.height=h;
  const ctx=c.getContext("2d");
  ctx.fillStyle="#000"; ctx.fillRect(0,0,w,h);

  const cell= Math.floor(w/3);
  let idx=0;
  for(let r=0;r<3;r++){
    for(let col=0;col<3;col++){
      const jx=(idx%3-1)*18;
      const jy=(1-(idx%3))*14;
      ctx.drawImage(base, jx, jy, base.width, base.height, col*cell, r*cell, cell, cell);
      idx++;
    }
  }
  // lines
  ctx.strokeStyle="rgba(255,255,255,.18)";
  ctx.lineWidth=2;
  for(let i=1;i<3;i++){
    ctx.beginPath(); ctx.moveTo(i*cell,0); ctx.lineTo(i*cell,h); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0,i*cell); ctx.lineTo(w,i*cell); ctx.stroke();
  }
  // glow corner
  ctx.globalAlpha=0.22;
  ctx.fillStyle="#00f0ff";
  ctx.fillRect(0,0,220,220);
  ctx.globalAlpha=1;
  return c;
}

/* ---------- Mini pack thumbs (packSize) ---------- */
function makeMiniThumb(base, i, shape="square"){
  const c=document.createElement("canvas");
  c.width=84;c.height=84;
  const ctx=c.getContext("2d");
  const jx=(i%5-2)*10;
  const jy=(2-(i%5))*8;

  if(shape==="round"){
    ctx.save();
    ctx.beginPath();
    ctx.arc(42,42,40,0,Math.PI*2);
    ctx.clip();
    ctx.drawImage(base, jx, jy, base.width, base.height, 0,0,84,84);
    ctx.restore();
  } else {
    ctx.drawImage(base, jx, jy, base.width, base.height, 0,0,84,84);
  }
  ctx.fillStyle="rgba(255,255,255,.08)";
  ctx.fillRect(0,0,84,28);
  return c;
}

/* ---------- Post styles (wide & competitive) ---------- */
const POST_STYLES = [
  { key:"POV", name:"POV", txt:()=>`<b>POV:</b> —Ç—ã ‚Äú–ø—Ä–æ—Å—Ç–æ –≤—ã–ª–æ–∂–∏–ª(–∞) –∫—Ä—É–∂–æ–∫‚Äù ‚Äî –∞ –ª—é–¥–∏ –∑–∞–ª–∏–ø–ª–∏.` },
  { key:"INSIDER", name:"–ò–Ω—Å–∞–π–¥–µ—Ä", txt:()=>`<b>–ò–Ω—Å–∞–π–¥:</b> —É–¥–µ—Ä–∂–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –≤–∞—Ä–∏–∞–Ω—Ç—ã.\n–°–µ–π—á–∞—Å –ø–æ–∫–∞–∂—É –Ω–µ—Å–∫–æ–ª—å–∫–æ.` },
  { key:"CHECK", name:"–ß–µ–∫–ª–∏—Å—Ç", txt:()=>`<b>–ß–µ–∫–ª–∏—Å—Ç ‚Äú—Å–º–æ—Ç—Ä–∏—Ç—Å—è –¥–æ—Ä–æ–≥–æ‚Äù</b>:\n‚Äî —á–∏—Å—Ç—ã–π —Ñ–æ–Ω\n‚Äî zoom 1.10\n‚Äî FIT –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç` },
  { key:"HOTT", name:"Hot take", txt:()=>`<b>–ì–æ—Ä—è—á–µ–µ –º–Ω–µ–Ω–∏–µ:</b> –æ–¥–∏–Ω —Ñ–∞–π–ª ‚Äî —Å–∫—É—á–Ω–æ.\n–ü–∞–∫ —Ä–µ—à–∞–µ—Ç.` },
  { key:"CHAT", name:"Chat", txt:()=>`<b>—Ç—ã:</b> —Å–¥–µ–ª–∞–π –∫—Ä–∞—Å–∏–≤–æ\n<b>CADRART:</b> –¥–µ—Ä–∂–∏ üòà` },
  { key:"MINI", name:"–ú–∏–Ω–∏–º–∞–ª", txt:()=>`<b>–æ–¥–∏–Ω –∫–∞–¥—Ä</b>.\n<i>–æ–¥–Ω–∞ –º—ã—Å–ª—å</i>.\n–∏ –≤—Å—ë.` },
  { key:"STORY", name:"Story-time", txt:()=>`–°–Ω–∞—á–∞–ª–∞ –±—ã–ª –∫–∞–¥—Ä.\n–ü–æ—Ç–æ–º –ø–∞–∫.\n–ü–æ—Ç–æ–º –ø–æ—Å—Ç ‚Äî –∏ –∞—É–¥–∏—Ç–æ—Ä–∏—è –æ—Å—Ç–∞–ª–∞—Å—å.` },
  { key:"BRAND", name:"–ë—Ä–µ–Ω–¥", txt:()=>`–°–ø–æ–∫–æ–π–Ω–æ. –ß—ë—Ç–∫–æ. –£–∑–Ω–∞–≤–∞–µ–º–æ.\n–¢–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –±—Ä–µ–Ω–¥.` },
  { key:"POLL", name:"–û–ø—Ä–æ—Å", txt:()=>`–í—ã–±–µ—Ä–∏:\nA) 16:9\nB) 9:16\nC) –∫–æ–ª–ª–∞–∂\n(—è –∑–∞ B)` },
  { key:"SECRET", name:"–°–µ–∫—Ä–µ—Ç", txt:()=>`<b>–°–µ–∫—Ä–µ—Ç:</b> –∫—Ä–∞—Å–∏–≤—ã–π –∫–∞–¥—Ä + –º–∞–ª–µ–Ω—å–∫–∏–µ –¥–µ—Ç–∞–ª–∏.\n–ü–∞–∫ —ç–º–æ–¥–∑–∏ ‚Äî —ç—Ç–æ –¥–µ—Ç–∞–ª–∏.` },
  { key:"HOOK", name:"–•—É–∫", txt:()=>`–°–µ–π—á–∞—Å –ø–æ–∫–∞–∂—É —Ñ–æ—Ä–º–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –ª—é–¥–∏ –¥–æ—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç.` },
  { key:"SOFT", name:"–ú—è–≥–∫–æ", txt:()=>`–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî —Å–æ–±–µ—Ä—É —Ç–µ–±–µ –Ω–∞–±–æ—Ä:\n–º–µ–¥–∏–∞ + —Ç–µ–∫—Å—Ç + –ø–∞–∫.\n–ë–µ–∑ —Å—É–µ—Ç—ã.` },
];

/* ---------- Feed media types (include random collage-grid) ---------- */
const MEDIA_TYPES = [
  { key:"circle", label:"‚óè Live Circle preview", make:(b)=>makeCanvas_circle(b), cta:"–°–æ–±—Ä–∞—Ç—å Live Circle", applyMode:"live_circle", packShape:"round" },
  { key:"avatar", label:"üë§ Avatar Circle preview", make:(b)=>makeCanvas_circle(b), cta:"–°–æ–±—Ä–∞—Ç—å Avatar Circle", applyMode:"avatar_circle", packShape:"round" },
  { key:"16x9", label:"üñ• 16:9", make:(b)=>makeCanvas_16x9(b), cta:"–°–æ–±—Ä–∞—Ç—å 16:9", applyMode:"16_9", packShape:"square" },
  { key:"9x16", label:"üì± 9:16", make:(b)=>makeCanvas_9x16(b), cta:"–°–æ–±—Ä–∞—Ç—å 9:16", applyMode:"9_16", packShape:"square" },
  { key:"19x6", label:"üéû 19:6 banner", make:(b)=>makeCanvas_19x6(b), cta:"–°–æ–±—Ä–∞—Ç—å –±–∞–Ω–Ω–µ—Ä", applyMode:"16_9", packShape:"square" },
  { key:"split", label:"‚úÇÔ∏è Split collage", make:(b)=>makeCanvas_split(b), cta:"–°–æ–±—Ä–∞—Ç—å split", applyMode:"16_9", packShape:"square" },
  { key:"mosaic", label:"üß© Mosaic collage", make:(b)=>makeCanvas_mosaic(b), cta:"–°–æ–±—Ä–∞—Ç—å –∫–æ–ª–ª–∞–∂", applyMode:"16_9", packShape:"square" },
  { key:"gridCollage", label:"üé≤ Collage Grid", make:(b)=>makeCanvas_gridCollage(b), cta:"–°–æ–±—Ä–∞—Ç—å –∫–æ–ª–ª–∞–∂-—Å–µ—Ç–∫—É", applyMode:"grid_3x3", packShape:"square" },
];

function randInt(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function html(s){ return s.replace(/\n/g,"<br/>"); }
function humanTime(){ return `${randInt(1,59)} –º–∏–Ω –Ω–∞–∑–∞–¥`; }

/* ---------- Create feed (3 posts) ---------- */
function skeletonPost(){
  const s=document.createElement("div");
  s.className="post";
  s.innerHTML=`
    <div class="postHdr">
      <div class="chan">
        <div class="ava"></div>
        <div>
          <div class="nm">cadrart</div>
          <div class="tm">–≥–µ–Ω–µ—Ä–∏–º‚Ä¶</div>
        </div>
      </div>
      <div class="dot">‚ãØ</div>
    </div>
    <div class="media" style="height:180px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.75)">
      ‚ú® —Å–æ–±–∏—Ä–∞–µ–º –∫—Ä–∞—Å–æ—Ç—É‚Ä¶
    </div>
    <div class="postBody">
      <div class="postText" style="opacity:.7">–°–µ–∫—É–Ω–¥—É‚Ä¶</div>
    </div>
  `;
  return s;
}

async function makeFeed(count=3){
  const base = await captureBaseCanvas(900);
  const stylePool = shuffle(POST_STYLES);
  const mediaPool = shuffle(MEDIA_TYPES);

  for(let i=0;i<count;i++){
    const media = mediaPool[i % mediaPool.length];
    const style = stylePool[i % stylePool.length];

    const post=document.createElement("div");
    post.className="post";
    post.innerHTML=`
      <div class="postHdr">
        <div class="chan">
          <div class="ava"></div>
          <div>
            <div class="nm">cadrart</div>
            <div class="tm">${humanTime()} ‚Ä¢ <span style="color:var(--mut)">${style.name}</span></div>
          </div>
        </div>
        <div class="dot">‚ãØ</div>
      </div>
      <div class="media">
        <div class="mediaBadge">${media.label} ‚Ä¢ FIT=${fit.toUpperCase()}</div>
        <div class="mediaCta">${media.cta}</div>
      </div>
      <div class="postBody">
        <div class="postText">${html(style.txt())}</div>
        <div class="miniPack"></div>
        <div class="postActions">
          <div class="act primary">–°–æ–±—Ä–∞—Ç—å —Ç–∞–∫ –∂–µ</div>
          <div class="act">–î–∞–π –µ—â—ë</div>
          <div class="act">–°–º–µ–Ω–∏—Ç—å –≤–∞–π–±</div>
        </div>
      </div>
    `;

    const mediaBox = post.querySelector(".media");
    const c = media.make(base);
    mediaBox.insertBefore(c, mediaBox.children[1]);
    c.style.width="100%";
    c.style.height="auto";

    // mini pack
    const pack = post.querySelector(".miniPack");
    const shape = media.packShape || (Math.random()<0.35 ? "round":"square");
    for(let k=1;k<=packSize;k++){
      const holder=document.createElement("div");
      holder.className="m"+(shape==="round"?" round":"");
      holder.appendChild(makeMiniThumb(base, k, shape));
      pack.appendChild(holder);
    }

    const cta = post.querySelector(".mediaCta");
    const actBuild = post.querySelectorAll(".act")[0];
    const actMore = post.querySelectorAll(".act")[1];
    const actVibe = post.querySelectorAll(".act")[2];

    function sendThis(){
      setMode(media.applyMode);
      tgSendData({
        type:"video_setup",
        mode: MODES.find(x=>x.key===media.applyMode)?.render || resolveRenderMode(),
        framing: normalizedFraming(),
        pack: { size: packSize, emoji_format: "vp9_webm" },
        preview: { media: media.key, style: style.key }
      });
      setTab("edit");
    }
    function more(){
      // slot-machine —ç—Ñ—Ñ–µ–∫—Ç: —É–¥–∞–ª–∏—Ç—å –∏ –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–≤–µ—Ä—Ö—É
      post.remove();
      feedEl.insertBefore(skeletonPost(), feedEl.firstChild);
      setTimeout(async()=>{
        feedEl.firstChild && feedEl.firstChild.remove();
        await makeFeed(1);
      }, 130);
    }
    function vibe(){
      const s2 = pick(POST_STYLES);
      post.querySelector(".tm").innerHTML = `${humanTime()} ‚Ä¢ <span style="color:var(--mut)">${s2.name}</span>`;
      post.querySelector(".postText").innerHTML = html(s2.txt());
    }

    cta.onclick=sendThis;
    actBuild.onclick=sendThis;
    actMore.onclick=more;
    actVibe.onclick=vibe;

    feedEl.insertBefore(post, feedEl.firstChild);
  }
}

/* ---------- Buttons ---------- */
document.getElementById("btnMakeFeed").onclick=async()=>{
  feedEl.innerHTML="";
  feedEl.appendChild(skeletonPost());
  setTab("feed");
  await makeFeed(3);
  feedEl.firstChild && feedEl.firstChild.querySelector(".tm")?.textContent.includes("–≥–µ–Ω–µ—Ä–∏–º") && feedEl.firstChild.remove();
};

document.getElementById("btnSend").onclick=()=>{
  tgSendData({
    type:"video_setup",
    mode: resolveRenderMode(),
    framing: normalizedFraming(),
    pack: { size: packSize, emoji_format: "vp9_webm" },
  });
};

document.getElementById("btnBackToEdit").onclick=()=>setTab("edit");
document.getElementById("btnFeedToBot").onclick=()=>{
  tgSendData({
    type:"video_setup",
    mode: resolveRenderMode(),
    framing: normalizedFraming(),
    pack: { size: packSize, emoji_format: "vp9_webm" },
    ui: { source:"feed" }
  });
};

document.getElementById("chipNewFeed").onclick=async()=>{ await makeFeed(3); };
document.getElementById("chipShuffleStyles").onclick=async()=>{ await makeFeed(2); };
document.getElementById("chipSwitchFit").onclick=()=>{
  setFit(fit==="cover" ? "contain" : "cover");
  alert(`FIT —Ç–µ–ø–µ—Ä—å: ${fit.toUpperCase()}`);
};

document.getElementById("chipExplain").onclick=()=>{
  alert(
`CADRART —Ä–µ–∂–∏–º—ã:
‚óè Live Circle ‚Äî –∫—Ä—É–∂–æ–∫ ‚Äú—è –æ–Ω–ª–∞–π–Ω‚Äù (video_note mp4 1:1).
üë§ Avatar Circle ‚Äî –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–π –∫—Ä—É–∂–æ–∫ (mp4 1:1).
üßø Emoji Pack VP9 ‚Äî –º–∏–Ω–∏-—ç–º–æ–¥–∑–∏/—Å—Ç–∏–∫–µ—Ä—ã (webm vp9).
üì± 9:16 ‚Äî reels/shorts (–ª—É—á—à–µ FIT=CONTAIN + zoom 0.6‚Äì0.9 –¥–ª—è –æ—Ç–¥–∞–ª–µ–Ω–∏—è).
üñ• 16:9 ‚Äî YouTube/–æ–±–ª–æ–∂–∫–∏ (FIT=CONTAIN).
üß© 3√ó3 / üßµ 20√ó1 ‚Äî –ø–∞–∫–∏ —ç–º–æ—Ü–∏–π.
üé≤ Random Layout ‚Äî –∫–æ–ª–ª–∞–∂/—Å–µ—Ç–∫–∞/–±–∞–Ω–Ω–µ—Ä —Ä–∞–Ω–¥–æ–º.`
  );
};

/* ---------- Random collage/grid generator (combo tab) ---------- */
const randInfo = document.getElementById("randInfo");

function doRandomLayout(showInfo=false){
  const options = [
    { name:"Split collage", applyMode:"16_9", fitSuggest:"contain" },
    { name:"Mosaic collage", applyMode:"16_9", fitSuggest:"contain" },
    { name:"19:6 Banner", applyMode:"16_9", fitSuggest:"contain" },
    { name:"Collage Grid (3√ó3)", applyMode:"grid_3x3", fitSuggest:"cover" },
    { name:"Emoji Pack VP9", applyMode:"emoji_pack", fitSuggest:"cover" },
    { name:"9:16 Focus", applyMode:"9_16", fitSuggest:"contain" },
  ];
  const picked = pick(options);
  randomLayoutName = picked.name;
  if(showInfo) randInfo.textContent = `${picked.name} ‚Ä¢ —Å–æ–≤–µ—Ç FIT=${picked.fitSuggest.toUpperCase()}`;

  // apply suggested fit without forcing
  // (–ª—É—á—à–µ –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å, –Ω–æ –º–æ–∂–Ω–æ –∏ –∞–≤—Ç–æ–ø—Ä–∏–º–µ–Ω—è—Ç—å ‚Äî –¥–µ–ª–∞—é –º—è–≥–∫–æ: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ç—Ä–æ–≥–∞–ª, –ø—Ä–∏–º–µ–Ω–∏–º)
  if(fit !== picked.fitSuggest){
    // –º—è–≥–∫–∏–π –∞–≤—Ç–æ—Å–≤–∏—Ç—á —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–µ –∫—Ä—É—Ç–∏–ª –∑—É–º —Å–∏–ª—å–Ω–æ
    if(Math.abs((parseFloat(zoom.value)||1) - 1) < 0.06){
      setFit(picked.fitSuggest);
    }
  }

  setMode(picked.applyMode);
}

document.getElementById("chipRandLayout").onclick=()=>{
  doRandomLayout(true);
  setTab("combo");
};

document.getElementById("chipRandomNow").onclick=()=>{
  doRandomLayout(true);
};

document.getElementById("chipGoFeed").onclick=async()=>{
  feedEl.innerHTML="";
  feedEl.appendChild(skeletonPost());
  setTab("feed");
  await makeFeed(3);
  feedEl.firstChild && feedEl.firstChild.querySelector(".tm")?.textContent.includes("–≥–µ–Ω–µ—Ä–∏–º") && feedEl.firstChild.remove();
};

document.getElementById("chipBackEdit").onclick=()=>setTab("edit");

/* ---------- Default ---------- */
setFit("cover");
setPack(12);
</script>
</body>
</html>
